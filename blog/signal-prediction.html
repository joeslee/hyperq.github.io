<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Signal Prediction</title>
    <link rel="stylesheet" type="text/css" href="../style/css/scarce.css"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="generator" content="o-blog version 1.2-149-g73e41e0"/>

<script src="../style/js/jquery-1.7.1.min.js" type="text/javascript"></script>
<script src="../style/bootstrap/js/bootstrap-modal.js" type="text/javascript"></script>
<script src="../style/bootstrap/js/bootstrap-transition.js" type="text/javascript"></script>
<script src="../style/bootstrap/js/bootstrap-dropdown.js" type="text/javascript"></script>
<script src="../style/bootstrap/js/bootstrap-collapse.js" type="text/javascript"></script>
<script src="../style/js/prettify.js" type="text/javascript"></script>
<script src="../style/js/o-blog.linenumber.js" type="text/javascript"></script>
<script src="../style/js/o-blog-fix.js" type="text/javascript"></script>
<script src="../style/js/scarce.js" type="text/javascript"></script>
<script src="../style/js/twitter-bootstrap-hover-dropdown.js" type="text/javascript"></script>



<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-22236293-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

<!-- Le fav and touch icons -->
<link rel="shortcut icon" href="../favicon.ico?v=2">
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../style/ico/apple-touch-icon-144-precomposed.png">
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="../style/ico/apple-touch-icon-114-precomposed.png">
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="../style/ico/apple-touch-icon-72-precomposed.png">
<link rel="apple-touch-icon-precomposed" href="../style/ico/apple-touch-icon-57-precomposed.png">

</head>
<body>

<div class="container">
  <div class="navbar navbar-inverse">
  <div class="navbar-inner">
    <div class="container">
      <a class="btn btn-navbar" data-toggle="collapse" data-hover=".nav-collapse" data-target=".nav-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </a>
      <a class="brand" href="../index.html">hyperq</a>
      <div class="nav-collapse collapse">
          <ul class="nav">
   <li>
     <a href="../about.html"><i>icon-user icon-white</i> About</a>
   </li>
   <li>
  <a class="caret-before" href="../blog/trading-a-hacker-approach.html">
       <i class="icon-coffee icon-white">
       </i>
       Blog
     </a>
  </li>
   <li class="dropdown">
 <a class="dropdown-toggle caret-after" data-toggle="dropdown" data-hover="dropdown" data-delay="2000">
 </a>
     <ul class="dropdown-menu">


<li><a href="../blog/trading-a-hacker-approach.html">Trading: a hacker approach?</a></li><li><a href="../blog/event-feed-design.html">Event Feed Design</a></li><li><a href="../blog/hyperq.html">hyperq</a></li><li><a href="../blog/zipline.html">zipline</a></li>

  </ul>

  </li>
  <li><a href="https://github.com/hyperq/hyperq"><i>icon-github icon-white</i>repo</a>

  </li>
  <li><a href="../tags.html"><i>icon-tags icon-white</i> Tags</a>

  </li>
  <li><a href="../archives.html"><i>icon-list icon-white</i> Archives</a>

  </li>
  <li><a href="../index.xml"><i>icon-rss icon-white</i> RSS</a>
  </li>
  <li><a href="http://scarcecapital.com"><i>icon-home icon-white</i> scarce,</a>
  </li>

  </ul>

      </div>
    </div>
  </div>
</div>

</div>

<div id="page">
  <div class="row">    
    <div class="arrow_nav top">
      <a class="previous skiphover" href="../blog/statistical-forecasting.html">
                                    <span class="symbol">
                                    </span>
                                    <span class="label">
                                       older
                                    </span>
                                    <span class="tooltip">
                                      Statistical Forecasting
                                    </span>
                                 </a>
      <div class="sepline"></div>
      <a class="previous skiphover" href="../blog/project-news-april-232013.html">
                                    <span class="label">
                                       newer
                                    </span>
                                    <span class="symbol">
                                       >
                                    </span>                                      
                                    <span class="tooltip">
                                      Project News April 23,2013
                                    </span>
                                 </a>
    </div>
  </div>
  <div class="row-fluid">
    <div class="span9">
      <article>
        <header class="article-header">
          <h1 class="post-header">Signal Prediction</h1>
          <h3 class="date-header"></h3>
          <h3 class="date-header">22 April 2013</h3>
        </header>
        <div class="article-content">
          <script type="text/javascript"
  src="https://c328740.ssl.cf1.rackcdn.com/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

<p>
The analytics below takes the weighted moment function (wmom<sup><a id="fnr.1" name="fnr.1" class="footref" href="#fn.1">1</a></sup>) discussed in the
previous post and applies the thinking to daily data on the SP500. The main
purpose is to provide examples of:
</p>
<ul class="org-ul">
<li>using wmom to replicate trading signals in a flexible and generic way.
</li>
<li>re-using wmom to estimate future return distribution and then apply that
distribution to workshop future evolution of the signal.
</li>
<li>use of the bigvis package to compress and represent large data sets.
</li>
</ul>

<p>
It's not commonly known that market signals involving moving averages are
forecastable. You know with certainty the returns that are dropping out of the
calculation and if we have some idea of the future stochastics, we can
estimate a distribution of return innovations that is anything but a random
walk. In other words, we can arrive at a probability that a signal will ping
without doing anything involving guessing market direction. This effect is
small, but as the analysis shows, there is a large and profitable gap between
perfect execution contemporaneous with a signal ping, and execution before
the ping based on future signal evolution that doesn't involve guessing future
market direction.
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">sp500 data</h2>
<div class="outline-text-2" id="text-1">
<div class="org-src-container">

<pre class="src src-R"><span class="org-ess-function-call">rm</span><span class="org-builtin">(</span>list <span class="org-constant">=</span> <span class="org-ess-function-call">ls</span><span class="org-builtin">())</span>
<span class="org-constant">require</span><span class="org-builtin">(</span>xts<span class="org-builtin">)</span>
<span class="org-constant">require</span><span class="org-builtin">(</span>quantmod<span class="org-builtin">)</span>
<span class="org-ess-function-call">options</span><span class="org-builtin">(</span>warn<span class="org-constant">=-</span><span class="org-ess-numbers">1</span><span class="org-builtin">)</span>
<span class="org-ess-function-call">Sys.setenv</span><span class="org-builtin">(</span>TZ<span class="org-constant">=</span><span class="org-string">'GMT'</span><span class="org-builtin">)</span>
<span class="org-ess-function-call">getSymbols</span><span class="org-builtin">(</span><span class="org-string">"^GSPC"</span>,src<span class="org-constant">=</span><span class="org-string">'yahoo'</span>, from<span class="org-constant">=</span><span class="org-string">'1927-01-01'</span><span class="org-builtin">)</span>
sp500.price<span class="org-constant">=</span><span class="org-ess-function-call">na.omit</span><span class="org-builtin">(</span><span class="org-ess-function-call">Cl</span><span class="org-builtin">(</span>GSPC<span class="org-builtin">))</span>
sp500<span class="org-constant">=</span><span class="org-ess-function-call">log</span><span class="org-builtin">(</span>sp500.price<span class="org-constant">/</span><span class="org-ess-function-call">lag</span><span class="org-builtin">(</span>sp500.price,<span class="org-ess-numbers">1</span><span class="org-builtin">))</span>
sp500<span class="org-constant">=</span>sp500<span class="org-builtin">[</span><span class="org-constant">-</span><span class="org-ess-numbers">1</span><span class="org-builtin">]</span>
<span class="org-ess-function-call">colnames</span><span class="org-builtin">(</span>sp500<span class="org-builtin">)</span><span class="org-constant">=</span><span class="org-string">"sp500"</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">wmom</h2>
<div class="outline-text-2" id="text-2">
<p>
The function:
</p>
<ul class="org-ul">
<li>first calculates the weighted mean for every day of the return series.
</li>
<li>fills in the initial mean values using the weights.  This is equivalent to
assuming returns prior to the time series were zero.
</li>
<li>uses the mean series as a centering for the weighted volatility calculation.
</li>
</ul>

<div class="org-src-container">

<pre class="src src-R">wmom <span class="org-constant">=</span> <span class="org-keyword">function</span><span class="org-builtin">(</span>rets, weights<span class="org-builtin">)</span> <span class="org-builtin">{</span>
  mean<span class="org-constant">=</span><span class="org-ess-function-call">as.double</span><span class="org-builtin">(</span><span class="org-ess-function-call">filter</span><span class="org-builtin">(</span>rets,weights$mean,sides<span class="org-constant">=</span><span class="org-ess-numbers">1</span><span class="org-builtin">))</span>
  mean<span class="org-builtin">[</span><span class="org-ess-numbers">1</span>:<span class="org-ess-function-call">length</span><span class="org-builtin">(</span>weights$mean<span class="org-builtin">)]</span><span class="org-constant">=</span><span class="org-ess-function-call">cumsum</span><span class="org-builtin">(</span>rets<span class="org-builtin">[</span><span class="org-ess-numbers">1</span>:<span class="org-ess-function-call">length</span><span class="org-builtin">(</span>weights$mean<span class="org-builtin">)]</span>*<span class="org-ess-function-call">as.matrix</span><span class="org-builtin">(</span>weights$mean<span class="org-builtin">))</span>
  xvol<span class="org-constant">=</span><span class="org-builtin">(</span>rets<span class="org-constant">-</span>mean<span class="org-builtin">)</span>^<span class="org-ess-numbers">2</span>
  vol<span class="org-constant">=</span><span class="org-ess-function-call">as.double</span><span class="org-builtin">(</span><span class="org-ess-function-call">filter</span><span class="org-builtin">(</span>xvol,weights$vol,sides<span class="org-constant">=</span><span class="org-ess-numbers">1</span><span class="org-builtin">))</span>^<span class="org-ess-numbers">0.5</span>
  vol<span class="org-builtin">[</span><span class="org-ess-numbers">1</span>:<span class="org-ess-function-call">length</span><span class="org-builtin">(</span>weights$vol<span class="org-builtin">)]</span><span class="org-constant">=</span><span class="org-ess-function-call">cumsum</span><span class="org-builtin">(</span>xvol<span class="org-builtin">[</span><span class="org-ess-numbers">1</span>:<span class="org-ess-function-call">length</span><span class="org-builtin">(</span>weights$vol<span class="org-builtin">)]</span>*<span class="org-ess-function-call">as.matrix</span><span class="org-builtin">(</span>weights$vol<span class="org-builtin">))</span>^<span class="org-ess-numbers">0.5</span>
  wmom<span class="org-constant">=</span><span class="org-ess-function-call">data.frame</span><span class="org-builtin">(</span>mean<span class="org-constant">=</span>mean, vol<span class="org-constant">=</span>vol<span class="org-builtin">)</span>
<span class="org-builtin">}</span>
</pre>
</div>

<ul class="org-ul">
<li>unit test
<div class="org-src-container">

<pre class="src src-R">rets<span class="org-constant">=</span>sp500
weights<span class="org-constant">=</span>weights
<span class="org-comment-delimiter">#</span><span class="org-comment">wmom = function(rets, weights) {</span>
  mean<span class="org-constant">=</span><span class="org-ess-function-call">as.double</span><span class="org-builtin">(</span><span class="org-ess-function-call">filter</span><span class="org-builtin">(</span>rets,weights$mean,sides<span class="org-constant">=</span><span class="org-ess-numbers">1</span><span class="org-builtin">))</span>
  mean<span class="org-builtin">[</span><span class="org-ess-numbers">1</span>:<span class="org-ess-function-call">length</span><span class="org-builtin">(</span>weights$mean<span class="org-builtin">)]</span><span class="org-constant">=</span><span class="org-ess-function-call">cumsum</span><span class="org-builtin">(</span>rets<span class="org-builtin">[</span><span class="org-ess-numbers">1</span>:<span class="org-ess-function-call">length</span><span class="org-builtin">(</span>weights$mean<span class="org-builtin">)]</span>*<span class="org-ess-function-call">as.matrix</span><span class="org-builtin">(</span>weights$mean<span class="org-builtin">))</span>
  xvol<span class="org-constant">=</span><span class="org-builtin">(</span>rets<span class="org-constant">-</span>mean<span class="org-builtin">)</span>^<span class="org-ess-numbers">2</span>
  vol<span class="org-constant">=</span><span class="org-ess-function-call">as.double</span><span class="org-builtin">(</span><span class="org-ess-function-call">filter</span><span class="org-builtin">(</span>xvol,weights$vol,sides<span class="org-constant">=</span><span class="org-ess-numbers">1</span><span class="org-builtin">))</span>^<span class="org-ess-numbers">0.5</span>
  vol<span class="org-builtin">[</span><span class="org-ess-numbers">1</span>:<span class="org-ess-function-call">length</span><span class="org-builtin">(</span>weights$vol<span class="org-builtin">)]</span><span class="org-constant">=</span><span class="org-ess-function-call">cumsum</span><span class="org-builtin">(</span>xvol<span class="org-builtin">[</span><span class="org-ess-numbers">1</span>:<span class="org-ess-function-call">length</span><span class="org-builtin">(</span>weights$vol<span class="org-builtin">)]</span>*<span class="org-ess-function-call">as.matrix</span><span class="org-builtin">(</span>weights$vol<span class="org-builtin">))</span>^<span class="org-ess-numbers">0.5</span>
  wmom<span class="org-constant">=</span><span class="org-ess-function-call">data.frame</span><span class="org-builtin">(</span>mean<span class="org-constant">=</span>mean, vol<span class="org-constant">=</span>vol<span class="org-builtin">)</span>
<span class="org-comment-delimiter">#</span><span class="org-comment">}</span>
</pre>
</div>
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">moments regression</h2>
<div class="outline-text-2" id="text-3">
<p>
Future volatility is highly forecastable, based on historical volatility and
historical mean return.  This always needs to be accounted for any statitical
analysis of time series and will often result in random varaites moving from
being fat-tailed to normal.
</p>

<div class="org-src-container">

<pre class="src src-R">l<span class="org-constant">=</span><span class="org-ess-numbers">251</span>
weights<span class="org-constant">=</span><span class="org-ess-function-call">data.frame</span><span class="org-builtin">(</span>mean<span class="org-constant">=</span><span class="org-ess-function-call">rep</span><span class="org-builtin">(</span><span class="org-ess-numbers">1</span><span class="org-constant">/</span>l,l<span class="org-builtin">)</span>,vol<span class="org-constant">=</span><span class="org-ess-function-call">rep</span><span class="org-builtin">(</span><span class="org-ess-numbers">1</span><span class="org-constant">/</span>l,l<span class="org-builtin">))</span>
m<span class="org-constant">=</span><span class="org-ess-function-call">wmom</span><span class="org-builtin">(</span>sp500,weights<span class="org-builtin">)</span>
data<span class="org-constant">=</span><span class="org-ess-function-call">data.frame</span><span class="org-builtin">(</span>sp500<span class="org-builtin">[</span><span class="org-constant">-</span><span class="org-ess-numbers">1</span><span class="org-builtin">]</span>,sp500<span class="org-builtin">[</span><span class="org-constant">-</span><span class="org-ess-numbers">1</span><span class="org-builtin">]</span>^<span class="org-ess-numbers">2</span>,
  m$mean<span class="org-builtin">[</span><span class="org-constant">-</span><span class="org-ess-function-call">length</span><span class="org-builtin">(</span>m$mean<span class="org-builtin">)]</span>,m$vol<span class="org-builtin">[</span><span class="org-constant">-</span><span class="org-ess-function-call">length</span><span class="org-builtin">(</span>m$vol<span class="org-builtin">)])</span> <span class="org-comment-delimiter">#</span><span class="org-comment">1 day delay in signal</span>
<span class="org-ess-function-call">colnames</span><span class="org-builtin">(</span>data<span class="org-builtin">)</span><span class="org-constant">=</span><span class="org-ess-function-call">c</span><span class="org-builtin">(</span><span class="org-string">"sp500"</span>,<span class="org-string">"sp500.vol"</span>,<span class="org-string">"hmean"</span>,<span class="org-string">"hvol"</span><span class="org-builtin">)</span>
fit.mean <span class="org-constant">=</span> <span class="org-ess-function-call">lm</span><span class="org-builtin">(</span>sp500 ~ hmean <span class="org-constant">+</span> hvol,data<span class="org-constant">=</span>data<span class="org-builtin">)</span>
<span class="org-ess-function-call">summary</span><span class="org-builtin">(</span>fit.mean<span class="org-builtin">)</span>
fit.vol <span class="org-constant">=</span> <span class="org-ess-function-call">lm</span><span class="org-builtin">(</span>sp500.vol ~ hmean <span class="org-constant">+</span> hvol,data<span class="org-constant">=</span>data<span class="org-builtin">)</span>
<span class="org-ess-function-call">summary</span><span class="org-builtin">(</span>fit.vol<span class="org-builtin">)</span>
</pre>
</div>

<pre class="example">
Call:
lm(formula = sp500 ~ hmean + hvol, data = data)

Residuals:
      Min        1Q    Median        3Q       Max 
-0.229363 -0.004412  0.000192  0.004681  0.109353 

Coefficients:
             Estimate Std. Error t value Pr(&gt;|t|)
(Intercept) 6.146e-05  2.167e-04   0.284    0.777
hmean       1.026e-01  1.338e-01   0.767    0.443
hvol        2.198e-02  2.086e-02   1.053    0.292

Residual standard error: 0.009785 on 15924 degrees of freedom
Multiple R-squared:  7.934e-05, Adjusted R-squared:  -4.625e-05 
F-statistic: 0.6317 on 2 and 15924 DF,  p-value: 0.5317

Call:
lm(formula = sp500.vol ~ hmean + hvol, data = data)

Residuals:
      Min        1Q    Median        3Q       Max 
-0.000542 -0.000076 -0.000039  0.000006  0.052346 

Coefficients:
              Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) -1.993e-05  1.138e-05  -1.751     0.08 .  
hmean       -6.077e-02  7.029e-03  -8.645   &lt;2e-16 ***
hvol         1.496e-02  1.096e-03  13.657   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.0005139 on 15924 degrees of freedom
Multiple R-squared:  0.02527,   Adjusted R-squared:  0.02515 
F-statistic: 206.4 on 2 and 15924 DF,  p-value: &lt; 2.2e-16
</pre>

<p>
So the regression indicates that historical mean and volatility strongly
predicts return^2.
</p>
</div>
</div>
<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4">ma(20) price performance</h2>
<div class="outline-text-2" id="text-4">
<p>
A variation of wmom as we don't need a weighted volatility estimate for the
price ma(20) signal.
</p>

<div class="org-src-container">

<pre class="src src-R">wmean <span class="org-constant">=</span> <span class="org-keyword">function</span><span class="org-builtin">(</span>rets, weights<span class="org-builtin">)</span> <span class="org-builtin">{</span>
  wm<span class="org-constant">=</span><span class="org-ess-function-call">as.double</span><span class="org-builtin">(</span><span class="org-ess-function-call">filter</span><span class="org-builtin">(</span>rets,weights,sides<span class="org-constant">=</span><span class="org-ess-numbers">1</span><span class="org-builtin">))</span>
  wm<span class="org-builtin">[</span><span class="org-ess-numbers">1</span>:<span class="org-ess-function-call">length</span><span class="org-builtin">(</span>weights<span class="org-builtin">)]</span><span class="org-constant">=</span><span class="org-ess-function-call">cumsum</span><span class="org-builtin">(</span>rets<span class="org-builtin">[</span><span class="org-ess-numbers">1</span>:<span class="org-ess-function-call">length</span><span class="org-builtin">(</span>weights<span class="org-builtin">)]</span>*<span class="org-ess-function-call">as.matrix</span><span class="org-builtin">(</span>weights<span class="org-builtin">))</span>
  wmean<span class="org-constant">=</span>wm
<span class="org-builtin">}</span>
</pre>
</div>

<p>
Weights as per the previous post analytics.
</p>

<div class="org-src-container">

<pre class="src src-R">rets<span class="org-constant">=</span>sp500
weights<span class="org-constant">=</span><span class="org-ess-function-call">seq</span><span class="org-builtin">(</span><span class="org-ess-numbers">0.95</span>,<span class="org-ess-numbers">0.05</span>,<span class="org-constant">-</span><span class="org-ess-numbers">0.05</span><span class="org-builtin">)</span>
<span class="org-comment-delimiter">#</span><span class="org-comment">wmean = function(rets, weights) {</span>
  wmean<span class="org-constant">=</span><span class="org-ess-function-call">as.double</span><span class="org-builtin">(</span><span class="org-ess-function-call">filter</span><span class="org-builtin">(</span>rets,weights,sides<span class="org-constant">=</span><span class="org-ess-numbers">1</span><span class="org-builtin">))</span>
  wmean<span class="org-builtin">[</span><span class="org-ess-numbers">1</span>:<span class="org-ess-function-call">length</span><span class="org-builtin">(</span>weights<span class="org-builtin">)]</span><span class="org-constant">=</span><span class="org-ess-function-call">cumsum</span><span class="org-builtin">(</span>rets<span class="org-builtin">[</span><span class="org-ess-numbers">1</span>:<span class="org-ess-function-call">length</span><span class="org-builtin">(</span>weights<span class="org-builtin">)]</span>*<span class="org-ess-function-call">as.matrix</span><span class="org-builtin">(</span>weights<span class="org-builtin">))</span>
<span class="org-comment-delimiter">#</span><span class="org-comment">}</span>
</pre>
</div>

<p>
And a move to analytics based on log(1+return) to remove compounding issues.
</p>

<div class="org-src-container">

<pre class="src src-R">sharpe <span class="org-constant">=</span> <span class="org-keyword">function</span><span class="org-builtin">(</span>rets<span class="org-builtin">)</span> <span class="org-builtin">{</span>
  m<span class="org-constant">=</span><span class="org-ess-function-call">sum</span><span class="org-builtin">(</span><span class="org-ess-function-call">log</span><span class="org-builtin">(</span><span class="org-ess-numbers">1</span><span class="org-constant">+</span>rets<span class="org-builtin">))</span><span class="org-constant">/</span><span class="org-ess-function-call">length</span><span class="org-builtin">(</span>rets<span class="org-builtin">)</span>*<span class="org-ess-numbers">251</span>
  v<span class="org-constant">=</span><span class="org-ess-function-call">sd</span><span class="org-builtin">(</span><span class="org-ess-function-call">log</span><span class="org-builtin">(</span><span class="org-ess-numbers">1</span><span class="org-constant">+</span>rets<span class="org-builtin">))</span>*<span class="org-builtin">(</span><span class="org-ess-numbers">251</span>^<span class="org-ess-numbers">0.5</span><span class="org-builtin">)</span>
  sharpe<span class="org-constant">=</span>m<span class="org-constant">/</span>v
<span class="org-builtin">}</span>
</pre>
</div>

<p>
The headline sharpe ratio for the signal is much higher than long-only.
</p>

<div class="org-src-container">

<pre class="src src-R">weights.ma20<span class="org-constant">=</span><span class="org-ess-function-call">seq</span><span class="org-builtin">(</span><span class="org-ess-numbers">0.95</span>,<span class="org-ess-numbers">0.05</span>,<span class="org-constant">-</span><span class="org-ess-numbers">0.05</span><span class="org-builtin">)</span>
m<span class="org-constant">=</span><span class="org-ess-function-call">wmean</span><span class="org-builtin">(</span>sp500,weights.ma20<span class="org-builtin">)</span>
sig<span class="org-constant">=</span><span class="org-ess-function-call">as.double</span><span class="org-builtin">(</span>m<span class="org-constant">&gt;</span><span class="org-ess-numbers">0</span><span class="org-builtin">)</span>
sig<span class="org-constant">=</span>sig<span class="org-builtin">[</span><span class="org-constant">-</span><span class="org-ess-function-call">length</span><span class="org-builtin">(</span>sig<span class="org-builtin">)]</span>
sharpe.long <span class="org-constant">=</span> <span class="org-ess-function-call">sharpe</span><span class="org-builtin">(</span>sp500<span class="org-builtin">[</span><span class="org-constant">-</span><span class="org-ess-numbers">1</span><span class="org-builtin">])</span>
sharpe.ma20 <span class="org-constant">=</span> <span class="org-ess-function-call">sharpe</span><span class="org-builtin">(</span>sp500<span class="org-builtin">[</span><span class="org-constant">-</span><span class="org-ess-numbers">1</span><span class="org-builtin">]</span>*sig<span class="org-builtin">)</span>
<span class="org-ess-function-call">c</span><span class="org-builtin">(</span>sharpe.long,sharpe.ma20<span class="org-builtin">)</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col class="left"/>

<col class="right"/>
</colgroup>
<tbody>
<tr>
<td class="left">sharpe long-only</td>
<td class="right">0.38</td>
</tr>

<tr>
<td class="left">sharpe price ma(20)</td>
<td class="right">0.61</td>
</tr>
</tbody>
</table>


<p>
The code below varies the delay between signal reading and trade execution.
</p>

<div class="org-src-container">

<pre class="src src-R">weights.ma20<span class="org-constant">=</span><span class="org-ess-function-call">seq</span><span class="org-builtin">(</span><span class="org-ess-numbers">0.95</span>,<span class="org-ess-numbers">0.05</span>,<span class="org-constant">-</span><span class="org-ess-numbers">0.05</span><span class="org-builtin">)</span>
m<span class="org-constant">=</span><span class="org-ess-function-call">wmean</span><span class="org-builtin">(</span>sp500,weights.ma20<span class="org-builtin">)</span>
sig<span class="org-constant">=</span><span class="org-ess-function-call">as.double</span><span class="org-builtin">(</span>m<span class="org-constant">&gt;</span><span class="org-ess-numbers">0</span><span class="org-builtin">)</span>
sharpe.ma20.delay <span class="org-constant">=</span> <span class="org-ess-function-call">rep</span><span class="org-builtin">(</span><span class="org-ess-numbers">0</span>,<span class="org-ess-numbers">20</span><span class="org-builtin">)</span>
sharpe.long.delay <span class="org-constant">=</span> <span class="org-ess-function-call">rep</span><span class="org-builtin">(</span><span class="org-ess-numbers">0</span>,<span class="org-ess-numbers">20</span><span class="org-builtin">)</span>

<span class="org-keyword">for</span> <span class="org-builtin">(</span>x1 <span class="org-keyword">in</span> <span class="org-ess-numbers">0</span>:<span class="org-ess-numbers">20</span><span class="org-builtin">)</span> <span class="org-builtin">{</span>
  sharpe.long.delay<span class="org-builtin">[</span>x1<span class="org-constant">+</span><span class="org-ess-numbers">1</span><span class="org-builtin">]</span> <span class="org-constant">=</span> <span class="org-ess-function-call">sharpe</span><span class="org-builtin">(</span>sp500<span class="org-builtin">[(</span>x1<span class="org-constant">+</span><span class="org-ess-numbers">1</span><span class="org-builtin">)</span>:<span class="org-ess-function-call">length</span><span class="org-builtin">(</span>sp500<span class="org-builtin">)])</span>
  sharpe.ma20.delay<span class="org-builtin">[</span>x1<span class="org-constant">+</span><span class="org-ess-numbers">1</span><span class="org-builtin">]</span> <span class="org-constant">=</span> <span class="org-ess-function-call">sharpe</span><span class="org-builtin">(</span>sp500<span class="org-builtin">[(</span>x1<span class="org-constant">+</span><span class="org-ess-numbers">1</span><span class="org-builtin">)</span>:<span class="org-ess-function-call">length</span><span class="org-builtin">(</span>sp500<span class="org-builtin">)]</span>*sig<span class="org-builtin">[</span><span class="org-ess-numbers">1</span>:<span class="org-builtin">(</span><span class="org-ess-function-call">length</span><span class="org-builtin">(</span>sp500<span class="org-builtin">)</span><span class="org-constant">-</span>x1<span class="org-builtin">)])</span>
<span class="org-builtin">}</span>
<span class="org-constant">require</span><span class="org-builtin">(</span>reshape<span class="org-builtin">)</span>
data <span class="org-constant">=</span> <span class="org-ess-function-call">melt</span><span class="org-builtin">(</span><span class="org-ess-function-call">data.frame</span><span class="org-builtin">(</span>sharpe.long.delay, sharpe.ma20.delay, delay<span class="org-constant">=</span><span class="org-ess-numbers">0</span>:<span class="org-ess-numbers">20</span><span class="org-builtin">)</span>,id<span class="org-constant">=</span><span class="org-string">"delay"</span><span class="org-builtin">)</span>
<span class="org-constant">require</span><span class="org-builtin">(</span>ggplot2<span class="org-builtin">)</span>
  <span class="org-ess-function-call">ggplot</span><span class="org-builtin">(</span>data<span class="org-constant">=</span>data,
         <span class="org-ess-function-call">aes</span><span class="org-builtin">(</span>x<span class="org-constant">=</span>delay, y<span class="org-constant">=</span>value,color<span class="org-constant">=</span>variable<span class="org-builtin">))</span> <span class="org-constant">+</span>
    <span class="org-ess-function-call">geom_line</span><span class="org-builtin">()</span>
</pre>
</div>


<div class="figure">
<p><img src="../blog/signal-prediction/ma20.delay.png"  alt="ma20.delay.png"/></p>
</div>

<p>
The calculation of sharpe according to signal delay illustrates a few
important principles:
</p>
<ul class="org-ul">
<li>a sharpe of 3.5 is what you get if you fail to be careful and introduce any
sort of look-ahead bias. When humans look at price charts versus moving
average lines, there is a failure to recognise that the apparently strong
relationship is due to look-ahead bias.  The eye includes the price
movement from before the lines cross which contains this large sharpe.
</li>
<li>signal effectiveness decays rapidly.  In this example, it is assumed that
the calculation of the signal and the trade are assumed to occur
simultaneously (at close).  Wait till next open and there is no excess
sharpe.
</li>
<li>any forecasting ability, ahead of the actual ping, can be a significant
profit opportunity and even in excess of the original signal sharpe.
</li>
</ul>
</div>
</div>
<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5">turnover adjustment</h2>
<div class="outline-text-2" id="text-5">
<div class="org-src-container">

<pre class="src src-R">sharpe.costs <span class="org-constant">=</span> <span class="org-keyword">function</span><span class="org-builtin">(</span>rets,turnover,cost<span class="org-builtin">)</span> <span class="org-builtin">{</span>
  m<span class="org-constant">=</span><span class="org-ess-function-call">sum</span><span class="org-builtin">(</span><span class="org-ess-function-call">log</span><span class="org-builtin">(</span><span class="org-ess-numbers">1</span><span class="org-constant">+</span>rets<span class="org-builtin">))</span><span class="org-constant">/</span><span class="org-ess-function-call">length</span><span class="org-builtin">(</span>rets<span class="org-builtin">)</span>*<span class="org-ess-numbers">251</span><span class="org-constant">-</span>turnover*cost
  v<span class="org-constant">=</span><span class="org-ess-function-call">sd</span><span class="org-builtin">(</span><span class="org-ess-function-call">log</span><span class="org-builtin">(</span><span class="org-ess-numbers">1</span><span class="org-constant">+</span>rets<span class="org-builtin">))</span>*<span class="org-builtin">(</span><span class="org-ess-numbers">251</span>^<span class="org-ess-numbers">0.5</span><span class="org-builtin">)</span>
  sharpe.costs<span class="org-constant">=</span>m<span class="org-constant">/</span>v
<span class="org-builtin">}</span>
</pre>
</div>

<div class="org-src-container">

<pre class="src src-R">turnover <span class="org-constant">=</span> <span class="org-ess-function-call">sum</span><span class="org-builtin">(</span><span class="org-ess-function-call">abs</span><span class="org-builtin">(</span><span class="org-ess-function-call">diff</span><span class="org-builtin">(</span>sig<span class="org-builtin">)))</span><span class="org-constant">/</span><span class="org-ess-function-call">length</span><span class="org-builtin">(</span>sig<span class="org-builtin">)</span>*<span class="org-ess-numbers">251</span>
x1<span class="org-constant">=</span><span class="org-ess-numbers">1</span>
scost <span class="org-constant">=</span> <span class="org-ess-function-call">sharpe.costs</span><span class="org-builtin">(</span>sp500<span class="org-builtin">[(</span>x1<span class="org-constant">+</span><span class="org-ess-numbers">1</span><span class="org-builtin">)</span>:<span class="org-ess-function-call">length</span><span class="org-builtin">(</span>sp500<span class="org-builtin">)]</span>*sig<span class="org-builtin">[</span><span class="org-ess-numbers">1</span>:<span class="org-builtin">(</span><span class="org-ess-function-call">length</span><span class="org-builtin">(</span>sp500<span class="org-builtin">)</span><span class="org-constant">-</span>x1<span class="org-builtin">)]</span>,turnover, <span class="org-ess-numbers">0.001</span><span class="org-builtin">)</span>
</pre>
</div>

<pre class="example">
0.340845298070155
</pre>

<p>
This signal is economically significant is trade costs are below 0.1%.
</p>
</div>
</div>

<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6">auto-conditionality estimates</h2>
<div class="outline-text-2" id="text-6">
<p>
Auto-conditionality is a made up term to represent the relationship between
historical mean and volatility of return and future distributional
characteristics.
</p>

<p>
parameter estimation
</p>

<div class="org-src-container">

<pre class="src src-R">l<span class="org-constant">=</span><span class="org-ess-numbers">251</span>
weights<span class="org-constant">=</span><span class="org-ess-function-call">data.frame</span><span class="org-builtin">(</span>mean<span class="org-constant">=</span><span class="org-ess-function-call">rep</span><span class="org-builtin">(</span><span class="org-ess-numbers">1</span><span class="org-constant">/</span>l,l<span class="org-builtin">)</span>,vol<span class="org-constant">=</span><span class="org-ess-function-call">rep</span><span class="org-builtin">(</span><span class="org-ess-numbers">1</span><span class="org-constant">/</span>l,l<span class="org-builtin">))</span>
m<span class="org-constant">=</span><span class="org-ess-function-call">wmom</span><span class="org-builtin">(</span>sp500,weights<span class="org-builtin">)</span>
data<span class="org-constant">=</span><span class="org-ess-function-call">data.frame</span><span class="org-builtin">(</span>sp500<span class="org-builtin">[</span><span class="org-constant">-</span><span class="org-ess-numbers">1</span><span class="org-builtin">]</span>,sp500<span class="org-builtin">[</span><span class="org-constant">-</span><span class="org-ess-numbers">1</span><span class="org-builtin">]</span>^<span class="org-ess-numbers">2</span>,
  m$mean<span class="org-builtin">[</span><span class="org-constant">-</span><span class="org-ess-function-call">length</span><span class="org-builtin">(</span>m$mean<span class="org-builtin">)]</span>,m$vol<span class="org-builtin">[</span><span class="org-constant">-</span><span class="org-ess-function-call">length</span><span class="org-builtin">(</span>m$vol<span class="org-builtin">)])</span> <span class="org-comment-delimiter">#</span><span class="org-comment">1 day delay in signal</span>
<span class="org-ess-function-call">colnames</span><span class="org-builtin">(</span>data<span class="org-builtin">)</span><span class="org-constant">=</span><span class="org-ess-function-call">c</span><span class="org-builtin">(</span><span class="org-string">"sp500"</span>,<span class="org-string">"sp500.vol"</span>,<span class="org-string">"hmean"</span>,<span class="org-string">"hvol"</span><span class="org-builtin">)</span>
fit.mean <span class="org-constant">=</span> <span class="org-ess-function-call">lm</span><span class="org-builtin">(</span>sp500 ~ <span class="org-ess-numbers">0</span> <span class="org-constant">+</span> hmean <span class="org-constant">+</span> hvol,data<span class="org-constant">=</span>data<span class="org-builtin">)</span>
<span class="org-ess-function-call">summary</span><span class="org-builtin">(</span>fit.mean<span class="org-builtin">)</span>
fit.vol <span class="org-constant">=</span> <span class="org-ess-function-call">lm</span><span class="org-builtin">((</span>sp500.vol<span class="org-constant">-</span><span class="org-ess-numbers">0.005</span>^<span class="org-ess-numbers">2</span><span class="org-builtin">)</span> ~ <span class="org-ess-numbers">0</span> <span class="org-constant">+</span> hmean <span class="org-constant">+</span> hvol,data<span class="org-constant">=</span>data<span class="org-builtin">)</span>
<span class="org-ess-function-call">summary</span><span class="org-builtin">(</span>fit.vol<span class="org-builtin">)</span>
</pre>
</div>

<pre class="example">
Call:
lm(formula = sp500 ~ 0 + hmean + hvol, data = data)

Residuals:
      Min        1Q    Median        3Q       Max 
-0.229373 -0.004402  0.000205  0.004693  0.109361 

Coefficients:
      Estimate Std. Error t value Pr(&gt;|t|)    
hmean 0.121620   0.115859   1.050 0.293862    
hvol  0.027419   0.008171   3.356 0.000793 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.009785 on 15925 degrees of freedom
Multiple R-squared:  0.0009223, Adjusted R-squared:  0.0007968 
F-statistic:  7.35 on 2 and 15925 DF,  p-value: 0.0006446

Call:
lm(formula = (sp500.vol - 0.005^2) ~ 0 + hmean + hvol, data = data)

Residuals:
      Min        1Q    Median        3Q       Max 
-0.000514 -0.000085 -0.000048 -0.000002  0.052353 

Coefficients:
        Estimate Std. Error t value Pr(&gt;|t|)    
hmean -0.0746577  0.0060882  -12.26   &lt;2e-16 ***
hvol   0.0109856  0.0004294   25.59   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.0005142 on 15925 degrees of freedom
Multiple R-squared:  0.04205,   Adjusted R-squared:  0.04193 
F-statistic: 349.5 on 2 and 15925 DF,  p-value: &lt; 2.2e-16
</pre>

<p>
vol estimate
</p>
<div class="org-src-container">

<pre class="src src-R">mean.est <span class="org-constant">=</span> <span class="org-ess-numbers">0.0003</span> <span class="org-constant">+</span> <span class="org-ess-numbers">0.12</span> * data$hmean <span class="org-constant">+</span> <span class="org-ess-numbers">0.011</span> * data$hvol
vol.est <span class="org-constant">=</span> <span class="org-ess-function-call">pmax</span><span class="org-builtin">(</span><span class="org-ess-numbers">0.005</span>^<span class="org-ess-numbers">2</span> <span class="org-constant">+</span> <span class="org-constant">-</span><span class="org-ess-numbers">0.075</span> * data$hmean <span class="org-constant">+</span> <span class="org-ess-numbers">0.027</span> * data$hvol<span class="org-builtin">)</span>^<span class="org-ess-numbers">0.5</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7">signal forecasting</h2>
<div class="outline-text-2" id="text-7">
<p>
Armed with a concrete signal (1 (long) if price is above ma(20) price and 0
if price is below ma(20) price) and a distribution theory about return
stochastics (volatility is auto-conditional), a forecast of the distribution
signal can be performed so that a probability statement about the future
signal can be made.  
</p>
</div>

<div id="outline-container-sec-7-1" class="outline-3">
<h3 id="sec-7-1">formulae</h3>
<div class="outline-text-3" id="text-7-1">
<p>
A bit of maths may help. The actual signal (the gap between current price and ma(20) of
price is a price signal which has been transformed into a return signal by
dividing by the oldest price (\(price_{20}\)). Tomorrows signal will be the same
return signal, but divided by \(price_{19}\).
</p>

<p>
The difference between the signal today and the signal tomorrow is:
</p>

\begin{align}
signal_{today} &= 0.95 \ast p_{0} - 0.05 \ast p_{1} - ... -0.05 \ast p_{19}\\
signal_{tomorrow} &= 0.95 \ast p_{-1} - 0.05 \ast p_{0} - ... -0.05 \ast p_{18}\\
\delta{signal} &= 0.95 \ast p_{-1} - 1.0 \ast p_{0} + 0.05 p_{19}
\end{align}

<p>
In return terms, (dividing by current price: \(price_{0}\))
</p>

\begin{multline}
\delta{signal}/price_{0} = 0.95 \ast return_{-1} - 0.05 \ast \sum_{0}^{18}return
\end{multline}

<p>
\(return_{-1}\) is tomorrows return because the subscript convention was to
label returns backwards in time.
</p>
</div>
</div>

<div id="outline-container-sec-7-2" class="outline-3">
<h3 id="sec-7-2">model</h3>
<div class="outline-text-3" id="text-7-2">
<p>
Modelling \(r_{-1}\) as a random variate r ~ N(0,vol.est) enables the signal to
be turned into a probabilistic measure (what is the probability of
the signal being long tomorrow?).
</p>

<div class="org-src-container">

<pre class="src src-R">price<span class="org-constant">=</span><span class="org-ess-function-call">c</span><span class="org-builtin">(</span><span class="org-ess-numbers">0</span>,<span class="org-ess-function-call">cumsum</span><span class="org-builtin">(</span><span class="org-ess-function-call">log</span><span class="org-builtin">(</span><span class="org-ess-numbers">1</span><span class="org-constant">+</span>sp500<span class="org-builtin">)))</span>
weights.av19 <span class="org-constant">=</span> <span class="org-ess-function-call">rep</span><span class="org-builtin">(</span><span class="org-ess-numbers">0.05</span>,<span class="org-ess-numbers">19</span><span class="org-builtin">)</span>
weights.av20 <span class="org-constant">=</span> <span class="org-ess-function-call">rep</span><span class="org-builtin">(</span><span class="org-ess-numbers">0.05</span>,<span class="org-ess-numbers">20</span><span class="org-builtin">)</span>
price.ma<span class="org-constant">=</span><span class="org-ess-function-call">as.double</span><span class="org-builtin">(</span><span class="org-ess-function-call">filter</span><span class="org-builtin">(</span>price,weights.av20,sides<span class="org-constant">=</span><span class="org-ess-numbers">1</span><span class="org-builtin">))</span>
price.ma<span class="org-builtin">[</span><span class="org-ess-numbers">1</span>:<span class="org-ess-function-call">length</span><span class="org-builtin">(</span>weights.av20<span class="org-builtin">)]</span><span class="org-constant">=</span><span class="org-ess-function-call">cumsum</span><span class="org-builtin">(</span>price<span class="org-builtin">[</span><span class="org-ess-numbers">1</span>:<span class="org-ess-function-call">length</span><span class="org-builtin">(</span>weights.av20<span class="org-builtin">)])</span><span class="org-constant">/</span><span class="org-ess-numbers">1</span>:<span class="org-ess-function-call">length</span><span class="org-builtin">(</span>weights.av20<span class="org-builtin">)</span>
gap<span class="org-constant">=</span>price<span class="org-constant">-</span>price.ma
st.mean.forecast <span class="org-constant">=</span> <span class="org-ess-numbers">0</span>
return.forecast <span class="org-constant">=</span> st.mean.forecast<span class="org-constant">-</span><span class="org-ess-function-call">c</span><span class="org-builtin">(</span><span class="org-ess-numbers">0</span>,<span class="org-ess-function-call">wmean</span><span class="org-builtin">(</span><span class="org-ess-function-call">log</span><span class="org-builtin">(</span><span class="org-ess-numbers">1</span><span class="org-constant">+</span>sp500<span class="org-builtin">)</span>,weights.av19<span class="org-builtin">))</span>
price.ma.delta <span class="org-constant">=</span> <span class="org-ess-function-call">c</span><span class="org-builtin">(</span><span class="org-ess-numbers">0</span>,price.ma<span class="org-builtin">[</span><span class="org-ess-numbers">1</span>:<span class="org-builtin">(</span><span class="org-ess-function-call">length</span><span class="org-builtin">(</span>price<span class="org-builtin">)</span><span class="org-constant">-</span><span class="org-ess-numbers">1</span><span class="org-builtin">)]</span> * return.forecast<span class="org-builtin">[</span><span class="org-ess-numbers">1</span>:<span class="org-builtin">(</span><span class="org-ess-function-call">length</span><span class="org-builtin">(</span>price<span class="org-builtin">)</span><span class="org-constant">-</span><span class="org-ess-numbers">1</span><span class="org-builtin">)])</span>
price.ma.forecast <span class="org-constant">=</span> <span class="org-ess-function-call">c</span><span class="org-builtin">(</span><span class="org-ess-numbers">0</span>,price.ma<span class="org-builtin">[</span><span class="org-ess-numbers">1</span>:<span class="org-builtin">(</span><span class="org-ess-function-call">length</span><span class="org-builtin">(</span>price<span class="org-builtin">)</span><span class="org-constant">-</span><span class="org-ess-numbers">1</span><span class="org-builtin">)])</span> <span class="org-constant">-</span> price.ma.delta
gap.forecast.norm <span class="org-constant">=</span> <span class="org-builtin">(</span><span class="org-ess-function-call">c</span><span class="org-builtin">(</span><span class="org-ess-numbers">0</span>,gap<span class="org-builtin">[</span><span class="org-ess-numbers">1</span>:<span class="org-builtin">(</span><span class="org-ess-function-call">length</span><span class="org-builtin">(</span>price<span class="org-builtin">)</span><span class="org-constant">-</span><span class="org-ess-numbers">1</span><span class="org-builtin">)])</span><span class="org-constant">+</span>price.ma.delta<span class="org-builtin">)</span><span class="org-constant">/</span><span class="org-ess-function-call">c</span><span class="org-builtin">(</span><span class="org-ess-numbers">0.005</span>,vol.est<span class="org-builtin">[</span><span class="org-ess-numbers">1</span>:<span class="org-builtin">(</span><span class="org-ess-function-call">length</span><span class="org-builtin">(</span>price<span class="org-builtin">)</span><span class="org-constant">-</span><span class="org-ess-numbers">1</span><span class="org-builtin">)])</span>
sig.forecast <span class="org-constant">=</span> <span class="org-ess-function-call">pnorm</span><span class="org-builtin">(</span>gap.forecast.norm<span class="org-builtin">)</span>
sig <span class="org-constant">=</span> <span class="org-ess-function-call">as.double</span><span class="org-builtin">(</span>gap<span class="org-constant">&gt;</span><span class="org-ess-numbers">0</span><span class="org-builtin">)</span>

df <span class="org-constant">=</span> <span class="org-ess-function-call">data.frame</span><span class="org-builtin">(</span>rets<span class="org-constant">=</span><span class="org-ess-function-call">c</span><span class="org-builtin">(</span><span class="org-ess-numbers">0</span>,sp500<span class="org-builtin">)</span>,price,price.ma,price.ma.forecast,sig,sig.forecast,
                 time<span class="org-constant">=</span><span class="org-ess-numbers">0</span>:<span class="org-builtin">(</span><span class="org-ess-function-call">length</span><span class="org-builtin">(</span>price<span class="org-builtin">)</span><span class="org-constant">-</span><span class="org-ess-numbers">1</span><span class="org-builtin">))</span>
<span class="org-ess-function-call">colnames</span><span class="org-builtin">(</span>df<span class="org-builtin">)</span> <span class="org-constant">=</span> <span class="org-ess-function-call">c</span><span class="org-builtin">(</span><span class="org-string">"rets"</span>,<span class="org-string">"price"</span>,<span class="org-string">"price.ma"</span>,<span class="org-string">"forecast.ma"</span>,<span class="org-string">"sig"</span>,<span class="org-string">"sig.forecast"</span>,<span class="org-string">"time"</span><span class="org-builtin">)</span>

<span class="org-constant">require</span><span class="org-builtin">(</span>ggplot2<span class="org-builtin">)</span>
<span class="org-constant">require</span><span class="org-builtin">(</span>reshape2<span class="org-builtin">)</span>    

df.melt <span class="org-constant">=</span> <span class="org-ess-function-call">melt</span><span class="org-builtin">(</span>df<span class="org-builtin">[</span><span class="org-ess-numbers">1</span>:<span class="org-ess-numbers">100</span>,<span class="org-builtin">]</span>,measure.vars<span class="org-constant">=</span><span class="org-ess-function-call">c</span><span class="org-builtin">(</span><span class="org-string">"price"</span>,<span class="org-string">"price.ma"</span>,<span class="org-string">"sig"</span>,<span class="org-string">"sig.forecast"</span><span class="org-builtin">))</span>

df.melt$type <span class="org-constant">=</span> <span class="org-ess-function-call">c</span><span class="org-builtin">(</span><span class="org-string">"sig"</span>,<span class="org-string">"price"</span><span class="org-builtin">)[</span><span class="org-ess-function-call">as.double</span><span class="org-builtin">(</span><span class="org-ess-function-call">is.element</span><span class="org-builtin">(</span>df.melt$variable,<span class="org-ess-function-call">as.factor</span><span class="org-builtin">(</span><span class="org-ess-function-call">c</span><span class="org-builtin">(</span><span class="org-string">"price"</span>,<span class="org-string">"price.ma"</span><span class="org-builtin">))))</span><span class="org-constant">+</span><span class="org-ess-numbers">1</span><span class="org-builtin">]</span>

<span class="org-ess-function-call">ggplot</span><span class="org-builtin">(</span>df.melt, <span class="org-ess-function-call">aes</span><span class="org-builtin">(</span>x <span class="org-constant">=</span> time, y <span class="org-constant">=</span> value<span class="org-builtin">))</span> <span class="org-constant">+</span>
  <span class="org-ess-function-call">geom_line</span><span class="org-builtin">(</span><span class="org-ess-function-call">aes</span><span class="org-builtin">(</span>color <span class="org-constant">=</span> variable<span class="org-builtin">))</span> <span class="org-constant">+</span>
  <span class="org-ess-function-call">facet_grid</span><span class="org-builtin">(</span>type ~ ., scales <span class="org-constant">=</span> <span class="org-string">"free_y"</span><span class="org-builtin">)</span>
</pre>
</div>


<div class="figure">
<p><img src="../blog/signal-prediction/sig.example.png"  alt="sig.example.png"/></p>
</div>

<p>
The example can be easily extended out beyond a day.
</p>
</div>
</div>
<div id="outline-container-sec-7-3" class="outline-3">
<h3 id="sec-7-3">signal forecast and returns</h3>
<div class="outline-text-3" id="text-7-3">
<p>
Return histograms for various signal probabilities is shown below:
</p>

<div class="org-src-container">

<pre class="src src-R"><span class="org-constant">require</span><span class="org-builtin">(</span>bigvis<span class="org-builtin">)</span>
<span class="org-constant">require</span><span class="org-builtin">(</span>grid<span class="org-builtin">)</span>
tweak <span class="org-constant">&lt;-</span> <span class="org-ess-function-call">list</span><span class="org-builtin">(</span>
  <span class="org-ess-function-call">theme</span><span class="org-builtin">(</span>
    legend.position <span class="org-constant">=</span> <span class="org-string">"bottom"</span>,
    plot.margin <span class="org-constant">=</span> <span class="org-ess-function-call">unit</span><span class="org-builtin">(</span><span class="org-ess-function-call">c</span><span class="org-builtin">(</span><span class="org-ess-numbers">0</span>, <span class="org-ess-numbers">0.5</span>, <span class="org-ess-numbers">0</span>, <span class="org-ess-numbers">0.5</span><span class="org-builtin">)</span>, <span class="org-string">"lines"</span><span class="org-builtin">)</span>,
    legend.key.width <span class="org-constant">=</span> <span class="org-ess-function-call">unit</span><span class="org-builtin">(</span><span class="org-ess-numbers">1</span>, <span class="org-string">"inches"</span><span class="org-builtin">)</span>,
    text <span class="org-constant">=</span> <span class="org-ess-function-call">element_text</span><span class="org-builtin">(</span>size <span class="org-constant">=</span> <span class="org-ess-numbers">18</span><span class="org-builtin">)</span>
  <span class="org-builtin">)</span>,
  <span class="org-ess-function-call">labs</span><span class="org-builtin">(</span>x <span class="org-constant">=</span> <span class="org-type">NULL</span>, y <span class="org-constant">=</span> <span class="org-type">NULL</span>, fill <span class="org-constant">=</span> <span class="org-type">NULL</span><span class="org-builtin">)</span>,
  <span class="org-ess-function-call">scale_fill_gradient</span><span class="org-builtin">(</span>low<span class="org-constant">=</span><span class="org-string">"#e5e5e5"</span>, high <span class="org-constant">=</span> <span class="org-string">"#444548"</span><span class="org-builtin">)</span>
<span class="org-builtin">)</span>

ret.sum <span class="org-constant">=</span> <span class="org-ess-function-call">condense</span><span class="org-builtin">(</span><span class="org-ess-function-call">bin</span><span class="org-builtin">(</span>df$sig.forecast,<span class="org-ess-numbers">0.02</span><span class="org-builtin">)</span>,<span class="org-ess-function-call">bin</span><span class="org-builtin">(</span>df$rets,<span class="org-ess-numbers">0.002</span><span class="org-builtin">))</span>
rs <span class="org-constant">=</span> <span class="org-ess-function-call">peel</span><span class="org-builtin">(</span>ret.sum,<span class="org-ess-numbers">.95</span><span class="org-builtin">)</span>
<span class="org-ess-function-call">autoplot</span><span class="org-builtin">(</span>rs<span class="org-builtin">)</span> <span class="org-constant">+</span> tweak
</pre>
</div>


<div class="figure">
<p><img src="../blog/signal-prediction/sig.returns.png"  alt="sig.returns.png"/></p>
</div>
</div>
</div>
<div id="outline-container-sec-7-4" class="outline-3">
<h3 id="sec-7-4">mean and volatility variations</h3>
<div class="outline-text-3" id="text-7-4">
<div class="org-src-container">

<pre class="src src-R"><span class="org-constant">require</span><span class="org-builtin">(</span>bigvis<span class="org-builtin">)</span>
tweak <span class="org-constant">&lt;-</span> <span class="org-ess-function-call">list</span><span class="org-builtin">(</span>
  <span class="org-ess-function-call">scale_x_continuous</span><span class="org-builtin">(</span><span class="org-string">"Signal Probabilistic Forecast"</span>, breaks <span class="org-constant">=</span> <span class="org-ess-function-call">seq</span><span class="org-builtin">(</span><span class="org-ess-numbers">0</span>,<span class="org-ess-numbers">1</span>,<span class="org-ess-numbers">0.2</span><span class="org-builtin">))</span>,
  <span class="org-ess-function-call">ylab</span><span class="org-builtin">(</span><span class="org-type">NULL</span><span class="org-builtin">)</span>,
  <span class="org-ess-function-call">theme</span><span class="org-builtin">(</span>
    plot.margin <span class="org-constant">=</span> <span class="org-ess-function-call">unit</span><span class="org-builtin">(</span><span class="org-ess-function-call">c</span><span class="org-builtin">(</span><span class="org-ess-numbers">0</span>, <span class="org-ess-numbers">0</span>, <span class="org-ess-numbers">0</span>, <span class="org-ess-numbers">0</span><span class="org-builtin">)</span>, <span class="org-string">"lines"</span><span class="org-builtin">)</span>,
    text <span class="org-constant">=</span> <span class="org-ess-function-call">element_text</span><span class="org-builtin">(</span>size <span class="org-constant">=</span> <span class="org-ess-numbers">18</span><span class="org-builtin">)</span>,
    panel.margin <span class="org-constant">=</span> <span class="org-ess-function-call">unit</span><span class="org-builtin">(</span><span class="org-ess-numbers">0.25</span>, <span class="org-string">"cm"</span><span class="org-builtin">)</span>
  <span class="org-builtin">)</span>
<span class="org-builtin">)</span>
ret.sum <span class="org-constant">=</span> <span class="org-ess-function-call">condense</span><span class="org-builtin">(</span><span class="org-ess-function-call">bin</span><span class="org-builtin">(</span>df$sig.forecast,<span class="org-ess-numbers">0.02</span><span class="org-builtin">)</span>,z<span class="org-constant">=</span>df$rets, summary <span class="org-constant">=</span> <span class="org-string">"sd"</span><span class="org-builtin">)</span>

d <span class="org-constant">=</span> <span class="org-ess-function-call">data.frame</span><span class="org-builtin">(</span>
  ret <span class="org-constant">=</span> <span class="org-ess-function-call">rep</span><span class="org-builtin">(</span>ret.sum$df.sig.forecast,<span class="org-ess-numbers">3</span><span class="org-builtin">)</span>,
  summary <span class="org-constant">=</span> <span class="org-ess-function-call">rep</span><span class="org-builtin">(</span><span class="org-ess-function-call">c</span><span class="org-builtin">(</span><span class="org-string">"count"</span>,<span class="org-string">"mean"</span>,<span class="org-string">"sd"</span><span class="org-builtin">)</span>, each <span class="org-constant">=</span> <span class="org-ess-function-call">nrow</span><span class="org-builtin">(</span>ret.sum<span class="org-builtin">))</span>,
  value <span class="org-constant">=</span> <span class="org-ess-function-call">c</span><span class="org-builtin">(</span>ret.sum$.count, ret.sum$.mean*<span class="org-ess-numbers">251</span>, ret.sum$.sd*<span class="org-builtin">(</span><span class="org-ess-numbers">251</span>^<span class="org-ess-numbers">.5</span><span class="org-builtin">))</span>
<span class="org-builtin">)</span>

smoothes <span class="org-constant">&lt;-</span> <span class="org-ess-function-call">list</span><span class="org-builtin">(</span>
  count <span class="org-constant">=</span> <span class="org-ess-function-call">smooth</span><span class="org-builtin">(</span>ret.sum, <span class="org-ess-numbers">0.2</span>, var <span class="org-constant">=</span> <span class="org-string">".count"</span>, type <span class="org-constant">=</span> <span class="org-string">"robust"</span><span class="org-builtin">)</span>,
  mean <span class="org-constant">=</span> <span class="org-ess-function-call">smooth</span><span class="org-builtin">(</span>ret.sum, <span class="org-ess-numbers">0.2</span>, var <span class="org-constant">=</span> <span class="org-string">".mean"</span>, type <span class="org-constant">=</span> <span class="org-string">"robust"</span><span class="org-builtin">)</span>,
  sd <span class="org-constant">=</span> <span class="org-ess-function-call">smooth</span><span class="org-builtin">(</span>ret.sum, <span class="org-ess-numbers">0.2</span>, var <span class="org-constant">=</span> <span class="org-string">".sd"</span>, type <span class="org-constant">=</span> <span class="org-string">"robust"</span><span class="org-builtin">))</span>
smoothes$mean$.mean <span class="org-constant">=</span> smoothes$mean$.mean*<span class="org-ess-numbers">251</span>
smoothes$sd$.sd <span class="org-constant">=</span> smoothes$sd$.sd*<span class="org-builtin">(</span><span class="org-ess-numbers">251</span>^<span class="org-ess-numbers">0.5</span><span class="org-builtin">)</span>

smoothes <span class="org-constant">&lt;-</span> <span class="org-ess-function-call">Map</span><span class="org-builtin">(</span><span class="org-keyword">function</span><span class="org-builtin">(</span>x, n<span class="org-builtin">)</span> <span class="org-builtin">{</span>
  <span class="org-ess-function-call">names</span><span class="org-builtin">(</span>x<span class="org-builtin">)[</span><span class="org-ess-numbers">2</span><span class="org-builtin">]</span> <span class="org-constant">&lt;-</span> <span class="org-string">"value"</span>
  x$summary <span class="org-constant">&lt;-</span> n
  x
<span class="org-builtin">}</span>, smoothes, <span class="org-ess-function-call">names</span><span class="org-builtin">(</span>smoothes<span class="org-builtin">))</span>
smooth <span class="org-constant">&lt;-</span> <span class="org-ess-function-call">do.call</span><span class="org-builtin">(</span>rbind, smoothes<span class="org-builtin">)</span>
smooth$summary <span class="org-constant">&lt;-</span> <span class="org-ess-function-call">factor</span><span class="org-builtin">(</span>smooth$summary, levels <span class="org-constant">=</span> <span class="org-ess-function-call">c</span><span class="org-builtin">(</span><span class="org-string">"count"</span>, <span class="org-string">"mean"</span>, <span class="org-string">"sd"</span><span class="org-builtin">))</span>
<span class="org-ess-function-call">levels</span><span class="org-builtin">(</span>smooth$summary<span class="org-builtin">)[</span><span class="org-ess-numbers">1</span><span class="org-builtin">]</span> <span class="org-constant">&lt;-</span> <span class="org-string">"count"</span>

<span class="org-ess-function-call">qplot</span><span class="org-builtin">(</span>ret, value, data <span class="org-constant">=</span> d, geom <span class="org-constant">=</span> <span class="org-string">"line"</span><span class="org-builtin">)</span> <span class="org-constant">+</span>
  <span class="org-ess-function-call">facet_grid</span><span class="org-builtin">(</span>summary ~ ., scales <span class="org-constant">=</span> <span class="org-string">"free"</span><span class="org-builtin">)</span> <span class="org-constant">+</span>
  tweak <span class="org-constant">+</span>
  <span class="org-ess-function-call">geom_line</span><span class="org-builtin">(</span>data <span class="org-constant">=</span> smooth, <span class="org-ess-function-call">aes</span><span class="org-builtin">(</span>x<span class="org-constant">=</span>df.sig.forecast, y<span class="org-constant">=</span>value<span class="org-builtin">)</span>,colour<span class="org-constant">=</span><span class="org-string">"#000099"</span><span class="org-builtin">)</span>
</pre>
</div>


<div class="figure">
<p><img src="../blog/signal-prediction/sig.analysis.png"  alt="sig.analysis.png"/></p>
</div>

<p>
The chart above utilises the bigvis package to compress the return results
for the range of signal forecasts.
</p>

<p>
Clearly the price ma(20) signal is above all a proxy for volatility:
</p>
<ul class="org-ul">
<li>a signal forecast of 0 (price clearly below the moving average of price) is
strongly associated with increased volatility.  Volatility reduces sharpely
for signal strength above zero and continues to decrease as signal
increases.
</li>
<li>there is little difference between returns when the signal is clearly 1 and
the returns when the signal is clearly 0. Although probably not
statistically significant, there is some increase in the average return when
the signal probabilities are around 0.5. This may be associated with
resistance pressures on return when current price is at a popular moving
average line.
</li>
</ul>
</div>
</div>
</div>
<div id="footnotes">
<h2 class="footnotes">Footnotes: </h2>
<div id="text-footnotes">

<div class="footdef"><sup><a id="fn.1" name="fn.1" class="footnum" href="#fnr.1">1</a></sup> <p class="footpara">
refactored name.  Previous post referred to weighted.historical
</p></div>


</div>
</div>
        </div>
      </article>
    </div>  
    <div class ="span3">
      <div id="sidebar">
      <a href="https://twitter.com/share" class="twitter-share-button" data-hashtags="r">Tweet</a>
      <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
      <!-- Place this tag where you want the +1 button to render. -->
<div class="g-plusone" data-annotation="bubble" data-size="medium" data-width="300"></div>

<!-- Place this tag after the last +1 button tag. -->
<script type="text/javascript">
  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>

<div class="get-scarce">
      <p>feeds:   <a href="https://twitter.com/hyperq_">Twitter</a> | <a href="../index.xml">RSS</a> | <a href="http://eepurl.com/xZDev">Email</a>
      </p>
</div>


    <p>
      Top Posts:
      
    </p>
    <a class="postlink" href="../blog/event-feed-design.html">Event Feed Design</a><br><a class="postlink" href="../blog/signal-prediction.html">Signal Prediction</a><br><a class="postlink" href="../blog/statistical-forecasting.html">Statistical Forecasting</a><br><a class="postlink" href="../blog/latency-research.html">Latency Research</a>
    <p><br>Related Articles:<br></p><a class="postlink" href="../tags/r.html">R</a>
</div>

    </div>
  </div>
  <div class="row-fluid">
      <div class="span9">
<div id="disqus_thread"></div>
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'scarce'; // required: replace example with your forum shortname

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
</div>

  <hr>
<div id="footer">
  <div class="copyright" style="text-align: center;">
    Copyright <a href="http://github.com/hyperq">hyperq</a> 2013-2013

<p>Licensed under the Apache License, Version 2.0 (the "License");
you may not use this work except in compliance with the License.
You may obtain a copy of the License in the LICENSE file, or at:</p>

<p><a href="http://www.apache.org/licenses/LICENSE-2.0">http://www.apache.org/licenses/LICENSE-2.0</a></p>

<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>

  </div>  
  <p>
    Powered by
    <a href="http://twitter.github.com/bootstrap/">bootstrap</a>
     via 
    <a href="https://github.com/renard/o-blog">o-blog</a>.
  </p>
</div>

</div>
</body>
</html>
