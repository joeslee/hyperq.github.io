<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>Latency Research</title>
    <link rel="stylesheet" type="text/css" href="../style/css/scarce.css"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="generator" content="o-blog version 1.2-149-g73e41e0"/>

<script src="../style/js/jquery-1.7.1.min.js" type="text/javascript"></script>
<script src="../style/bootstrap/js/bootstrap-modal.js" type="text/javascript"></script>
<script src="../style/bootstrap/js/bootstrap-transition.js" type="text/javascript"></script>
<script src="../style/bootstrap/js/bootstrap-dropdown.js" type="text/javascript"></script>
<script src="../style/bootstrap/js/bootstrap-collapse.js" type="text/javascript"></script>
<script src="../style/js/prettify.js" type="text/javascript"></script>
<script src="../style/js/o-blog.linenumber.js" type="text/javascript"></script>
<script src="../style/js/o-blog-fix.js" type="text/javascript"></script>
<script src="../style/js/scarce.js" type="text/javascript"></script>
<script src="../style/js/twitter-bootstrap-hover-dropdown.js" type="text/javascript"></script>



<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-22236293-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>

<!-- Le fav and touch icons -->
<link rel="shortcut icon" href="../favicon.ico?v=2">
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../style/ico/apple-touch-icon-144-precomposed.png">
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="../style/ico/apple-touch-icon-114-precomposed.png">
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="../style/ico/apple-touch-icon-72-precomposed.png">
<link rel="apple-touch-icon-precomposed" href="../style/ico/apple-touch-icon-57-precomposed.png">

</head>
<body>

<div class="container">
  <div class="navbar navbar-inverse">
  <div class="navbar-inner">
    <div class="container">
      <a class="btn btn-navbar" data-toggle="collapse" data-hover=".nav-collapse" data-target=".nav-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </a>
      <a class="brand" href="../index.html">hyperq</a>
      <div class="nav-collapse collapse">
          <ul class="nav">
   <li>
     <a href="../about.html"><i>icon-user icon-white</i> About</a>
   </li>
   <li>
  <a class="caret-before" href="../blog/trading-a-hacker-approach.html">
       <i class="icon-coffee icon-white">
       </i>
       Blog
     </a>
  </li>
   <li class="dropdown">
 <a class="dropdown-toggle caret-after" data-toggle="dropdown" data-hover="dropdown" data-delay="2000">
 </a>
     <ul class="dropdown-menu">


<li><a href="../blog/trading-a-hacker-approach.html">Trading: a hacker approach?</a></li><li><a href="../blog/event-feed-design.html">Event Feed Design</a></li><li><a href="../blog/hyperq.html">hyperq</a></li><li><a href="../blog/zipline.html">zipline</a></li>

  </ul>

  </li>
  <li><a href="https://github.com/hyperq/hyperq"><i>icon-github icon-white</i>repo</a>

  </li>
  <li><a href="../tags.html"><i>icon-tags icon-white</i> Tags</a>

  </li>
  <li><a href="../archives.html"><i>icon-list icon-white</i> Archives</a>

  </li>
  <li><a href="../index.xml"><i>icon-rss icon-white</i> RSS</a>
  </li>
  <li><a href="http://scarcecapital.com"><i>icon-home icon-white</i> scarce,</a>
  </li>

  </ul>

      </div>
    </div>
  </div>
</div>

</div>

<div id="page">
  <div class="row">    
    <div class="arrow_nav top">
      <a class="previous skiphover" href="../blog/market-feed-choices.html">
                                    <span class="symbol">
                                    </span>
                                    <span class="label">
                                       older
                                    </span>
                                    <span class="tooltip">
                                      market feed choices
                                    </span>
                                 </a>
      <div class="sepline"></div>
      <a class="previous skiphover" href="../blog/statistical-forecasting.html">
                                    <span class="label">
                                       newer
                                    </span>
                                    <span class="symbol">
                                       >
                                    </span>                                      
                                    <span class="tooltip">
                                      Statistical Forecasting
                                    </span>
                                 </a>
    </div>
  </div>
  <div class="row-fluid">
    <div class="span9">
      <article>
        <header class="article-header">
          <h1 class="post-header">Latency Research</h1>
          <h3 class="date-header"></h3>
          <h3 class="date-header">12 April 2013</h3>
        </header>
        <div class="article-content">
          <p>
I collected trade and order ticks for 12 contracts on 14th March from iqfeed,
and timestamped each tick with current system time. There was about 8 million
data points.
</p>


<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">feed ping latency</h2>
<div class="outline-text-2" id="text-1">
<p>
Iqfeed sends a ping once a second as part of the stream.
</p>

<div class="org-src-container">

<pre class="src src-R">t <span class="org-constant">=</span> <span class="org-ess-function-call">read.csv</span><span class="org-builtin">(</span><span class="org-string">"data/streamt.txt"</span>,header<span class="org-constant">=</span><span class="org-type">FALSE</span>,as.is<span class="org-constant">=</span><span class="org-type">TRUE</span><span class="org-builtin">)</span>
pingtime <span class="org-constant">=</span> <span class="org-ess-function-call">strptime</span><span class="org-builtin">(</span>t<span class="org-builtin">[</span>,<span class="org-ess-numbers">3</span><span class="org-builtin">]</span>, <span class="org-string">"%Y%m%d %H:%M:%S"</span><span class="org-builtin">)</span>
stamp <span class="org-constant">=</span> <span class="org-ess-function-call">strptime</span><span class="org-builtin">(</span><span class="org-ess-function-call">paste</span><span class="org-builtin">(</span><span class="org-ess-function-call">strftime</span><span class="org-builtin">(</span>pingtime,<span class="org-string">"%Y%m%d"</span><span class="org-builtin">)</span>, t<span class="org-builtin">[</span>,<span class="org-ess-numbers">1</span><span class="org-builtin">]</span>, sep<span class="org-constant">=</span><span class="org-string">" "</span><span class="org-builtin">)</span>, <span class="org-string">"%Y%m%d %H:%M:%OS"</span><span class="org-builtin">)</span>
latency <span class="org-constant">=</span> <span class="org-ess-function-call">as.double</span><span class="org-builtin">(</span>stamp <span class="org-constant">-</span> pingtime<span class="org-builtin">)</span>
df <span class="org-constant">=</span> <span class="org-ess-function-call">data.frame</span><span class="org-builtin">(</span>pingtime<span class="org-constant">=</span>pingtime, latency<span class="org-constant">=</span>latency<span class="org-builtin">)</span>
<span class="org-ess-function-call">summary</span><span class="org-builtin">(</span>df<span class="org-builtin">)</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col class="left"/>

<col class="left"/>
</colgroup>
<tbody>
<tr>
<td class="left">Min.   :2013-03-14 07:30:57</td>
<td class="left">Min.   :-0.90665</td>
</tr>

<tr>
<td class="left">1st Qu.:2013-03-14 17:15:41</td>
<td class="left">1st Qu.:-0.01492</td>
</tr>

<tr>
<td class="left">Median :2013-03-15 03:02:15</td>
<td class="left">Median : 0.14950</td>
</tr>

<tr>
<td class="left">Mean   :2013-03-15 03:01:28</td>
<td class="left">Mean   : 0.38876</td>
</tr>

<tr>
<td class="left">3rd Qu.:2013-03-15 12:46:33</td>
<td class="left">3rd Qu.: 0.22824</td>
</tr>

<tr>
<td class="left">Max.   :2013-03-15 22:33:24</td>
<td class="left">Max.   : 7.89887</td>
</tr>

<tr>
<td class="left">NA's   :1</td>
<td class="left">NA's   :1</td>
</tr>
</tbody>
</table>

<div class="org-src-container">

<pre class="src src-R"><span class="org-constant">require</span><span class="org-builtin">(</span>ggplot2<span class="org-builtin">)</span>
<span class="org-ess-function-call">qplot</span><span class="org-builtin">(</span>data<span class="org-constant">=</span>df, x<span class="org-constant">=</span>pingtime, y<span class="org-constant">=</span>latency<span class="org-builtin">)</span>
<span class="org-ess-function-call">ggsave</span><span class="org-builtin">(</span><span class="org-string">"ping-latency.svg"</span><span class="org-builtin">)</span>
</pre>
</div>


<div class="figure">
<p><img src="../blog/latency-research/ping-latency.png"  alt="ping-latency.png"/></p>
</div>

<p>
The simple scatterplot shows many negative values, especially when the
market is open, and a step jump in the later pings (when no quotes were
being recorded).  These jumps may be due to changes in my system clock
(automatic appletime resolutions) or due to a lack of accuracy in the
iqfeed pings.
</p>

<p>
Scatterplots tend to provide dubious visualisation for bigdata, and a new
package out that helps is <a href="http://vita.had.co.nz/papers/bigvis.html">bigvis</a>.
</p>

<p>
Bigvis is not yet available at CRAN but can be installed via a github
repository (see <a href="https://github.com/hadley/bigvis">https://github.com/hadley/bigvis</a> for details).
</p>

<div class="org-src-container">

<pre class="src src-R"><span class="org-ess-function-call">install.packages</span><span class="org-builtin">(</span><span class="org-string">"devtools"</span><span class="org-builtin">)</span>
devtools::<span class="org-ess-function-call">install_github</span><span class="org-builtin">(</span><span class="org-string">"bigvis"</span><span class="org-builtin">)</span>
</pre>
</div>

<p>
Bigvis doesn't handle non-numeric data (like time), so rather than
autopilot, I use ggplot directly.
</p>

<div class="org-src-container">

<pre class="src src-R"><span class="org-constant">require</span><span class="org-builtin">(</span>bigvis<span class="org-builtin">)</span>
<span class="org-constant">require</span><span class="org-builtin">(</span>ggplot2<span class="org-builtin">)</span>
dfn <span class="org-constant">=</span> <span class="org-ess-function-call">condense</span><span class="org-builtin">(</span><span class="org-ess-function-call">bin</span><span class="org-builtin">(</span><span class="org-ess-function-call">as.double</span><span class="org-builtin">(</span>df$pingtime<span class="org-builtin">)</span>,<span class="org-ess-numbers">60</span><span class="org-builtin">)</span>,<span class="org-ess-function-call">bin</span><span class="org-builtin">(</span>df$latency,<span class="org-ess-numbers">.1</span><span class="org-builtin">))</span>
dfg <span class="org-constant">=</span> <span class="org-ess-function-call">data.frame</span><span class="org-builtin">(</span><span class="org-ess-function-call">as.POSIXct</span><span class="org-builtin">(</span>dfn<span class="org-builtin">[</span>,<span class="org-ess-numbers">1</span><span class="org-builtin">]</span>,origin<span class="org-constant">=</span><span class="org-string">"1960-01-01"</span>, tz<span class="org-constant">=</span><span class="org-string">"GMT"</span><span class="org-builtin">)</span>,dfn<span class="org-builtin">[</span>,<span class="org-ess-numbers">2</span><span class="org-builtin">]</span>,dfn<span class="org-builtin">[</span>,<span class="org-ess-numbers">3</span><span class="org-builtin">])</span>
<span class="org-ess-function-call">colnames</span><span class="org-builtin">(</span>dfg<span class="org-builtin">)</span> <span class="org-constant">=</span> <span class="org-ess-function-call">c</span><span class="org-builtin">(</span><span class="org-string">"Time"</span>,<span class="org-string">"Latency"</span>,<span class="org-string">"Count"</span><span class="org-builtin">)</span>
g <span class="org-constant">=</span> <span class="org-ess-function-call">ggplot</span><span class="org-builtin">(</span>data<span class="org-constant">=</span>dfg,<span class="org-ess-function-call">aes</span><span class="org-builtin">(</span>x<span class="org-constant">=</span>Time,y<span class="org-constant">=</span>Latency<span class="org-builtin">))</span>
g <span class="org-constant">+</span> <span class="org-ess-function-call">geom_tile</span><span class="org-builtin">(</span><span class="org-ess-function-call">aes</span><span class="org-builtin">(</span>fill<span class="org-constant">=</span>Count<span class="org-builtin">))</span> <span class="org-constant">+</span> <span class="org-ess-function-call">scale_fill_gradient</span><span class="org-builtin">(</span>low<span class="org-constant">=</span><span class="org-string">"#e5e5e5"</span>, high <span class="org-constant">=</span> <span class="org-string">"#444548"</span><span class="org-builtin">)</span> <span class="org-constant">+</span> <span class="org-ess-function-call">scale_y_continuous</span><span class="org-builtin">(</span>limits<span class="org-constant">=</span><span class="org-ess-function-call">c</span><span class="org-builtin">(</span><span class="org-constant">-</span><span class="org-ess-numbers">1</span>,<span class="org-ess-numbers">1</span><span class="org-builtin">))</span>
<span class="org-ess-function-call">ggsave</span><span class="org-builtin">(</span><span class="org-string">"ping-latency-condensed.svg"</span><span class="org-builtin">)</span>
</pre>
</div>


<div class="figure">
<p><img src="../blog/latency-research/ping-latency-condensed.svg"  alt="ping-latency-condensed.svg"/></p>
</div>

<p>
Using the bigvis techniques clarifies a few main issues for further research:
</p>
<ul class="org-ul">
<li>there is a step jump near market open where the majority of the pings
jump from around 250 msecs to -750 msecs. This looks like either a coding
error or the ping being off by up to a second.
</li>
<li>during market open (when tick volume is high) ping can vary by a second.
</li>
</ul>
</div>
</div>


<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">disconnects</h2>
<div class="outline-text-2" id="text-2">
<p>
Just looking at the ping counts after binning into one minute intervals:
</p>

<div class="org-src-container">

<pre class="src src-R">df.dis <span class="org-constant">=</span> <span class="org-ess-function-call">condense</span><span class="org-builtin">(</span><span class="org-ess-function-call">bin</span><span class="org-builtin">(</span><span class="org-ess-function-call">as.double</span><span class="org-builtin">(</span>df$pingtime<span class="org-builtin">)</span>,<span class="org-ess-numbers">60</span><span class="org-builtin">))</span>
dfg <span class="org-constant">=</span> <span class="org-ess-function-call">data.frame</span><span class="org-builtin">(</span><span class="org-ess-function-call">as.POSIXct</span><span class="org-builtin">(</span>df.dis<span class="org-builtin">[</span>,<span class="org-ess-numbers">1</span><span class="org-builtin">]</span>,origin<span class="org-constant">=</span><span class="org-string">"1960-01-01"</span>, tz<span class="org-constant">=</span><span class="org-string">"GMT"</span><span class="org-builtin">)</span>,<span class="org-ess-numbers">60</span><span class="org-constant">-</span>df.dis<span class="org-builtin">[</span>,<span class="org-ess-numbers">2</span><span class="org-builtin">])</span>
<span class="org-ess-function-call">colnames</span><span class="org-builtin">(</span>dfg<span class="org-builtin">)</span> <span class="org-constant">=</span> <span class="org-ess-function-call">c</span><span class="org-builtin">(</span><span class="org-string">"Time"</span>,<span class="org-string">"Count"</span><span class="org-builtin">)</span>
g <span class="org-constant">=</span> <span class="org-ess-function-call">ggplot</span><span class="org-builtin">(</span>data<span class="org-constant">=</span>dfg,<span class="org-ess-function-call">aes</span><span class="org-builtin">(</span>x<span class="org-constant">=</span>Time,y<span class="org-constant">=</span>Count<span class="org-builtin">))</span>
g <span class="org-constant">+</span> <span class="org-ess-function-call">geom_line</span><span class="org-builtin">(</span><span class="org-ess-function-call">aes</span><span class="org-builtin">())</span>
<span class="org-ess-function-call">ggsave</span><span class="org-builtin">(</span><span class="org-string">"disconnects.png"</span><span class="org-builtin">)</span>
</pre>
</div>


<div class="figure">
<p><img src="../blog/latency-research/disconnects.png"  alt="disconnects.png"/></p>
</div>

<p>
iqfeed regularly suffers from disconnects with reconnection occuring within
a minute.
</p>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3">event latency</h2>
<div class="outline-text-2" id="text-3">
<p>
The ticks for the day were processed into column-data formats using the mmap
package from R (see hyperq.org for the gory details).
</p>

<p>
From the R database of the one day quote ticks&#x2026;
</p>

<ul class="org-ul">
<li>open data
<div class="org-src-container">

<pre class="src src-R"><span class="org-ess-function-call">rm</span><span class="org-builtin">(</span>list <span class="org-constant">=</span> <span class="org-ess-function-call">ls</span><span class="org-builtin">())</span>
<span class="org-constant">require</span><span class="org-builtin">(</span><span class="org-string">"mmap"</span><span class="org-builtin">)</span>
<span class="org-constant">require</span><span class="org-builtin">(</span><span class="org-string">"rindex"</span><span class="org-builtin">)</span>
<span class="org-constant">require</span><span class="org-builtin">(</span><span class="org-string">"plyr"</span><span class="org-builtin">)</span>
<span class="org-constant">require</span><span class="org-builtin">(</span><span class="org-string">"stringr"</span><span class="org-builtin">)</span>
raw.stream <span class="org-constant">=</span> <span class="org-string">"streamqh"</span>
<span class="org-comment-delimiter"># </span><span class="org-comment">where the mmap db is located</span>
db.path <span class="org-constant">=</span> <span class="org-ess-function-call">paste</span><span class="org-builtin">(</span><span class="org-string">"data/"</span>,raw.stream,<span class="org-string">"/"</span>,sep<span class="org-constant">=</span><span class="org-string">""</span><span class="org-builtin">)</span>

<span class="org-ess-function-call">load</span><span class="org-builtin">(</span><span class="org-ess-function-call">paste</span><span class="org-builtin">(</span>db.path,<span class="org-string">".Rdbinfo"</span>,sep<span class="org-constant">=</span><span class="org-string">""</span><span class="org-builtin">))</span>
<span class="org-comment-delimiter">#</span><span class="org-comment">m = mmap(main.filename, mode=st)</span>
stream <span class="org-constant">=</span> <span class="org-type">NULL</span>
stream$stamp <span class="org-constant">=</span> <span class="org-ess-function-call">mmap</span><span class="org-builtin">(</span><span class="org-ess-function-call">paste</span><span class="org-builtin">(</span>db.path,fields<span class="org-builtin">[</span><span class="org-ess-numbers">1</span><span class="org-builtin">]</span>,<span class="org-string">".data"</span>,sep<span class="org-constant">=</span><span class="org-string">""</span><span class="org-builtin">)</span>, mode<span class="org-constant">=</span><span class="org-ess-function-call">double</span><span class="org-builtin">())</span>
stream$code <span class="org-constant">=</span> <span class="org-ess-function-call">mmap</span><span class="org-builtin">(</span><span class="org-ess-function-call">paste</span><span class="org-builtin">(</span>db.path,fields<span class="org-builtin">[</span><span class="org-ess-numbers">2</span><span class="org-builtin">]</span>,<span class="org-string">".data"</span>,sep<span class="org-constant">=</span><span class="org-string">""</span><span class="org-builtin">)</span>, mode<span class="org-constant">=</span><span class="org-ess-function-call">char</span><span class="org-builtin">(</span><span class="org-ess-numbers">1</span><span class="org-builtin">))</span>
stream$symbol <span class="org-constant">=</span> <span class="org-ess-function-call">mmap</span><span class="org-builtin">(</span><span class="org-ess-function-call">paste</span><span class="org-builtin">(</span>db.path,fields<span class="org-builtin">[</span><span class="org-ess-numbers">3</span><span class="org-builtin">]</span>,<span class="org-string">".data"</span>,sep<span class="org-constant">=</span><span class="org-string">""</span><span class="org-builtin">)</span>, mode<span class="org-constant">=</span><span class="org-ess-function-call">char</span><span class="org-builtin">(</span>ticker.length<span class="org-builtin">))</span>
stream$trade <span class="org-constant">=</span> <span class="org-ess-function-call">mmap</span><span class="org-builtin">(</span><span class="org-ess-function-call">paste</span><span class="org-builtin">(</span>db.path,fields<span class="org-builtin">[</span><span class="org-ess-numbers">4</span><span class="org-builtin">]</span>,<span class="org-string">".data"</span>,sep<span class="org-constant">=</span><span class="org-string">""</span><span class="org-builtin">)</span>, mode<span class="org-constant">=</span><span class="org-ess-function-call">double</span><span class="org-builtin">())</span>
stream$vol <span class="org-constant">=</span> <span class="org-ess-function-call">mmap</span><span class="org-builtin">(</span><span class="org-ess-function-call">paste</span><span class="org-builtin">(</span>db.path,fields<span class="org-builtin">[</span><span class="org-ess-numbers">5</span><span class="org-builtin">]</span>,<span class="org-string">".data"</span>,sep<span class="org-constant">=</span><span class="org-string">""</span><span class="org-builtin">)</span>, mode<span class="org-constant">=</span><span class="org-ess-function-call">integer</span><span class="org-builtin">())</span>
stream$tradetime <span class="org-constant">=</span> <span class="org-ess-function-call">mmap</span><span class="org-builtin">(</span><span class="org-ess-function-call">paste</span><span class="org-builtin">(</span>db.path,fields<span class="org-builtin">[</span><span class="org-ess-numbers">6</span><span class="org-builtin">]</span>,<span class="org-string">".data"</span>,sep<span class="org-constant">=</span><span class="org-string">""</span><span class="org-builtin">)</span>, mode<span class="org-constant">=</span><span class="org-ess-function-call">double</span><span class="org-builtin">())</span>
stream$tradeex <span class="org-constant">=</span> <span class="org-ess-function-call">mmap</span><span class="org-builtin">(</span><span class="org-ess-function-call">paste</span><span class="org-builtin">(</span>db.path,fields<span class="org-builtin">[</span><span class="org-ess-numbers">7</span><span class="org-builtin">]</span>,<span class="org-string">".data"</span>,sep<span class="org-constant">=</span><span class="org-string">""</span><span class="org-builtin">)</span>, mode<span class="org-constant">=</span><span class="org-ess-function-call">double</span><span class="org-builtin">())</span>
stream$volex <span class="org-constant">=</span> <span class="org-ess-function-call">mmap</span><span class="org-builtin">(</span><span class="org-ess-function-call">paste</span><span class="org-builtin">(</span>db.path,fields<span class="org-builtin">[</span><span class="org-ess-numbers">8</span><span class="org-builtin">]</span>,<span class="org-string">".data"</span>,sep<span class="org-constant">=</span><span class="org-string">""</span><span class="org-builtin">)</span>, mode<span class="org-constant">=</span><span class="org-ess-function-call">integer</span><span class="org-builtin">())</span>
stream$tradetimeex <span class="org-constant">=</span> <span class="org-ess-function-call">mmap</span><span class="org-builtin">(</span><span class="org-ess-function-call">paste</span><span class="org-builtin">(</span>db.path,fields<span class="org-builtin">[</span><span class="org-ess-numbers">9</span><span class="org-builtin">]</span>,<span class="org-string">".data"</span>,sep<span class="org-constant">=</span><span class="org-string">""</span><span class="org-builtin">)</span>, mode<span class="org-constant">=</span><span class="org-ess-function-call">double</span><span class="org-builtin">())</span>
stream$voltot <span class="org-constant">=</span> <span class="org-ess-function-call">mmap</span><span class="org-builtin">(</span><span class="org-ess-function-call">paste</span><span class="org-builtin">(</span>db.path,fields<span class="org-builtin">[</span><span class="org-ess-numbers">10</span><span class="org-builtin">]</span>,<span class="org-string">".data"</span>,sep<span class="org-constant">=</span><span class="org-string">""</span><span class="org-builtin">)</span>, mode<span class="org-constant">=</span><span class="org-ess-function-call">integer</span><span class="org-builtin">())</span>
stream$bid <span class="org-constant">=</span> <span class="org-ess-function-call">mmap</span><span class="org-builtin">(</span><span class="org-ess-function-call">paste</span><span class="org-builtin">(</span>db.path,fields<span class="org-builtin">[</span><span class="org-ess-numbers">11</span><span class="org-builtin">]</span>,<span class="org-string">".data"</span>,sep<span class="org-constant">=</span><span class="org-string">""</span><span class="org-builtin">)</span>, mode<span class="org-constant">=</span><span class="org-ess-function-call">double</span><span class="org-builtin">())</span>
stream$bidvol <span class="org-constant">=</span> <span class="org-ess-function-call">mmap</span><span class="org-builtin">(</span><span class="org-ess-function-call">paste</span><span class="org-builtin">(</span>db.path,fields<span class="org-builtin">[</span><span class="org-ess-numbers">12</span><span class="org-builtin">]</span>,<span class="org-string">".data"</span>,sep<span class="org-constant">=</span><span class="org-string">""</span><span class="org-builtin">)</span>, mode<span class="org-constant">=</span><span class="org-ess-function-call">integer</span><span class="org-builtin">())</span>
stream$bidtime <span class="org-constant">=</span> <span class="org-ess-function-call">mmap</span><span class="org-builtin">(</span><span class="org-ess-function-call">paste</span><span class="org-builtin">(</span>db.path,fields<span class="org-builtin">[</span><span class="org-ess-numbers">13</span><span class="org-builtin">]</span>,<span class="org-string">".data"</span>,sep<span class="org-constant">=</span><span class="org-string">""</span><span class="org-builtin">)</span>, mode<span class="org-constant">=</span><span class="org-ess-function-call">double</span><span class="org-builtin">())</span>
stream$ask <span class="org-constant">=</span> <span class="org-ess-function-call">mmap</span><span class="org-builtin">(</span><span class="org-ess-function-call">paste</span><span class="org-builtin">(</span>db.path,fields<span class="org-builtin">[</span><span class="org-ess-numbers">14</span><span class="org-builtin">]</span>,<span class="org-string">".data"</span>,sep<span class="org-constant">=</span><span class="org-string">""</span><span class="org-builtin">)</span>, mode<span class="org-constant">=</span><span class="org-ess-function-call">double</span><span class="org-builtin">())</span>
stream$askvol <span class="org-constant">=</span> <span class="org-ess-function-call">mmap</span><span class="org-builtin">(</span><span class="org-ess-function-call">paste</span><span class="org-builtin">(</span>db.path,fields<span class="org-builtin">[</span><span class="org-ess-numbers">15</span><span class="org-builtin">]</span>,<span class="org-string">".data"</span>,sep<span class="org-constant">=</span><span class="org-string">""</span><span class="org-builtin">)</span>, mode<span class="org-constant">=</span><span class="org-ess-function-call">integer</span><span class="org-builtin">())</span>
stream$asktime <span class="org-constant">=</span> <span class="org-ess-function-call">mmap</span><span class="org-builtin">(</span><span class="org-ess-function-call">paste</span><span class="org-builtin">(</span>db.path,fields<span class="org-builtin">[</span><span class="org-ess-numbers">16</span><span class="org-builtin">]</span>,<span class="org-string">".data"</span>,sep<span class="org-constant">=</span><span class="org-string">""</span><span class="org-builtin">)</span>, mode<span class="org-constant">=</span><span class="org-ess-function-call">double</span><span class="org-builtin">())</span>
stream$event <span class="org-constant">=</span> <span class="org-ess-function-call">mmap</span><span class="org-builtin">(</span><span class="org-ess-function-call">paste</span><span class="org-builtin">(</span>db.path,fields<span class="org-builtin">[</span><span class="org-ess-numbers">17</span><span class="org-builtin">]</span>,<span class="org-string">".data"</span>,sep<span class="org-constant">=</span><span class="org-string">""</span><span class="org-builtin">)</span>, mode<span class="org-constant">=</span><span class="org-ess-function-call">char</span><span class="org-builtin">(</span><span class="org-ess-numbers">12</span><span class="org-builtin">))</span>
stream$id <span class="org-constant">=</span> <span class="org-ess-function-call">mmap</span><span class="org-builtin">(</span><span class="org-ess-function-call">paste</span><span class="org-builtin">(</span>db.path,fields<span class="org-builtin">[</span><span class="org-ess-numbers">18</span><span class="org-builtin">]</span>,<span class="org-string">".data"</span>,sep<span class="org-constant">=</span><span class="org-string">""</span><span class="org-builtin">)</span>, mode<span class="org-constant">=</span><span class="org-ess-function-call">integer</span><span class="org-builtin">())</span>
</pre>
</div>
</li>

<li>Define events and extract relevant times
<div class="org-src-container">

<pre class="src src-R">n <span class="org-constant">=</span> <span class="org-ess-function-call">length</span><span class="org-builtin">(</span>stream$event<span class="org-builtin">[])</span>

tC <span class="org-constant">=</span> <span class="org-ess-function-call">grepl</span><span class="org-builtin">(</span><span class="org-string">"C"</span>,stream$event<span class="org-builtin">[])</span>
tO <span class="org-constant">=</span> <span class="org-ess-function-call">grepl</span><span class="org-builtin">(</span><span class="org-string">"O"</span>,stream$event<span class="org-builtin">[])</span>
ta <span class="org-constant">=</span> <span class="org-ess-function-call">grepl</span><span class="org-builtin">(</span><span class="org-string">"a"</span>,stream$event<span class="org-builtin">[])</span>
tb <span class="org-constant">=</span> <span class="org-ess-function-call">grepl</span><span class="org-builtin">(</span><span class="org-string">"b"</span>,stream$event<span class="org-builtin">[])</span>
ta <span class="org-constant">=</span> ta &amp; !<span class="org-builtin">(</span>tC | tO<span class="org-builtin">)</span>
tb <span class="org-constant">=</span> tb &amp; !<span class="org-builtin">(</span>tC | tO | ta<span class="org-builtin">)</span>
tother <span class="org-constant">=</span> !<span class="org-builtin">(</span>ta | tb | tC | tO<span class="org-builtin">)</span>

event.category <span class="org-constant">=</span> <span class="org-builtin">(</span><span class="org-ess-numbers">1</span> * tC<span class="org-builtin">)</span> <span class="org-constant">+</span> <span class="org-builtin">(</span><span class="org-ess-numbers">2</span> * tO<span class="org-builtin">)</span> <span class="org-constant">+</span> <span class="org-builtin">(</span><span class="org-ess-numbers">3</span> * ta<span class="org-builtin">)</span> <span class="org-constant">+</span> <span class="org-builtin">(</span><span class="org-ess-numbers">4</span> * tb<span class="org-builtin">)</span> <span class="org-constant">+</span> <span class="org-builtin">(</span><span class="org-ess-numbers">5</span> * tother<span class="org-builtin">)</span>

event.time <span class="org-constant">=</span> <span class="org-builtin">(</span>stream$tradetime<span class="org-builtin">[]</span> * tC <span class="org-constant">+</span>
        stream$tradetimeex<span class="org-builtin">[]</span> * tO <span class="org-constant">+</span>
        stream$asktime<span class="org-builtin">[]</span> * ta <span class="org-constant">+</span>
        stream$bidtime<span class="org-builtin">[]</span> * tb <span class="org-constant">+</span>
        stream$tradetime<span class="org-builtin">[]</span> * tother<span class="org-builtin">)</span>

event.time.posix <span class="org-constant">=</span> <span class="org-ess-function-call">as.POSIXct</span><span class="org-builtin">(</span>event.time,origin<span class="org-constant">=</span><span class="org-string">"1960-01-01"</span>, tz<span class="org-constant">=</span><span class="org-string">"GMT"</span><span class="org-builtin">)</span>
event.stamp <span class="org-constant">=</span> stream$stamp<span class="org-builtin">[]</span>

event.latency <span class="org-constant">=</span> event.stamp <span class="org-constant">-</span> event.time

event.df <span class="org-constant">=</span> <span class="org-ess-function-call">data.frame</span><span class="org-builtin">(</span>symbol<span class="org-constant">=</span>stream$symbol<span class="org-builtin">[]</span>,event.category,event.time, event.stamp, event.latency<span class="org-builtin">)</span>
<span class="org-ess-function-call">summary</span><span class="org-builtin">(</span>event.df<span class="org-builtin">)</span>
</pre>
</div>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col class="left"/>

<col class="left"/>

<col class="left"/>

<col class="left"/>

<col class="left"/>
</colgroup>
<tbody>
<tr>
<td class="left">@ESM13 :2553308</td>
<td class="left">Min.   :1.000</td>
<td class="left">Min.   :1.366e+09</td>
<td class="left">Min.   :1.366e+09</td>
<td class="left">Min.   :-85800.76</td>
</tr>

<tr>
<td class="left">@NQM13 :1285545</td>
<td class="left">1st Qu.:3.000</td>
<td class="left">1st Qu.:1.366e+09</td>
<td class="left">1st Qu.:1.366e+09</td>
<td class="left">1st Qu.:     0.22</td>
</tr>

<tr>
<td class="left">@YMM13 :1216006</td>
<td class="left">Median :3.000</td>
<td class="left">Median :1.366e+09</td>
<td class="left">Median :1.366e+09</td>
<td class="left">Median :     0.33</td>
</tr>

<tr>
<td class="left">EBK13  : 917275</td>
<td class="left">Mean   :3.107</td>
<td class="left">Mean   :1.366e+09</td>
<td class="left">Mean   :1.366e+09</td>
<td class="left">Mean   :   226.44</td>
</tr>

<tr>
<td class="left">@JYM13 : 844995</td>
<td class="left">3rd Qu.:4.000</td>
<td class="left">3rd Qu.:1.366e+09</td>
<td class="left">3rd Qu.:1.366e+09</td>
<td class="left">3rd Qu.:   600.22</td>
</tr>

<tr>
<td class="left">EBM13  : 610827</td>
<td class="left">Max.   :5.000</td>
<td class="left">Max.   :1.366e+09</td>
<td class="left">Max.   :1.366e+09</td>
<td class="left">Max.   :  9818.25</td>
</tr>

<tr>
<td class="left">(Other):1373320</td>
<td class="left">nil</td>
<td class="left">nil</td>
<td class="left">nil</td>
<td class="left">nil</td>
</tr>
</tbody>
</table>
</li>

<li>bigvis manipulations
<div class="org-src-container">

<pre class="src src-R"><span class="org-constant">require</span><span class="org-builtin">(</span><span class="org-string">"bigvis"</span><span class="org-builtin">)</span>
<span class="org-constant">require</span><span class="org-builtin">(</span><span class="org-string">"ggplot2"</span><span class="org-builtin">)</span>
df1 <span class="org-constant">=</span> <span class="org-ess-function-call">condense</span><span class="org-builtin">(</span><span class="org-ess-function-call">bin</span><span class="org-builtin">(</span>event.df$event.time,<span class="org-ess-numbers">60</span><span class="org-builtin">)</span>,<span class="org-ess-function-call">bin</span><span class="org-builtin">(</span>event.df$event.latency,<span class="org-ess-numbers">0.05</span><span class="org-builtin">))</span>
df2 <span class="org-constant">=</span> df1<span class="org-builtin">[(</span>df1$event.df.event.latency <span class="org-constant">&gt;</span> <span class="org-ess-numbers">0</span><span class="org-builtin">)</span> &amp; <span class="org-builtin">(</span>df1$event.df.event.latency <span class="org-constant">&lt;</span> <span class="org-ess-numbers">1</span><span class="org-builtin">)</span>,<span class="org-builtin">]</span>
dfg <span class="org-constant">=</span> <span class="org-ess-function-call">data.frame</span><span class="org-builtin">(</span><span class="org-ess-function-call">as.POSIXct</span><span class="org-builtin">(</span>df2<span class="org-builtin">[</span>,<span class="org-ess-numbers">1</span><span class="org-builtin">]</span><span class="org-constant">+</span><span class="org-ess-numbers">10</span>*<span class="org-ess-numbers">60</span>*<span class="org-ess-numbers">60</span>,origin<span class="org-constant">=</span><span class="org-string">"1960-01-01"</span>, tz<span class="org-constant">=</span><span class="org-string">""</span><span class="org-builtin">)</span>,df2<span class="org-builtin">[</span>,<span class="org-ess-numbers">2</span><span class="org-builtin">]</span>,df2<span class="org-builtin">[</span>,<span class="org-ess-numbers">3</span><span class="org-builtin">])</span>
<span class="org-ess-function-call">colnames</span><span class="org-builtin">(</span>dfg<span class="org-builtin">)</span> <span class="org-constant">=</span> <span class="org-ess-function-call">c</span><span class="org-builtin">(</span><span class="org-string">"Time"</span>,<span class="org-string">"Latency"</span>,<span class="org-string">"Count"</span><span class="org-builtin">)</span>
g <span class="org-constant">=</span> <span class="org-ess-function-call">ggplot</span><span class="org-builtin">(</span>data<span class="org-constant">=</span>dfg,<span class="org-ess-function-call">aes</span><span class="org-builtin">(</span>x<span class="org-constant">=</span>Time,y<span class="org-constant">=</span>Latency<span class="org-builtin">))</span>
g <span class="org-constant">+</span> <span class="org-ess-function-call">geom_tile</span><span class="org-builtin">(</span><span class="org-ess-function-call">aes</span><span class="org-builtin">(</span>fill<span class="org-constant">=</span>Count<span class="org-builtin">))</span> <span class="org-constant">+</span> <span class="org-ess-function-call">scale_fill_gradient</span><span class="org-builtin">(</span>low<span class="org-constant">=</span><span class="org-string">"#e5e5e5"</span>, high <span class="org-constant">=</span> <span class="org-string">"#444548"</span><span class="org-builtin">)</span> <span class="org-constant">+</span> <span class="org-ess-function-call">scale_y_continuous</span><span class="org-builtin">(</span>limits<span class="org-constant">=</span><span class="org-ess-function-call">c</span><span class="org-builtin">(</span><span class="org-constant">-</span><span class="org-ess-numbers">1</span>,<span class="org-ess-numbers">1</span><span class="org-builtin">))</span>
<span class="org-ess-function-call">ggsave</span><span class="org-builtin">(</span><span class="org-string">"quote-latency-condensed.svg"</span><span class="org-builtin">)</span>
</pre>
</div>


<div class="figure">
<p><img src="../blog/latency-research/quote-latency-condensed.svg"  alt="quote-latency-condensed.svg"/></p>
</div>

<p>
Unlike the iqfeed ping, there is a consistent latency pattern when comparing
market stamp and local system stamp, with no spurious negative values.
Latency values from 9am to 4pm (regular market open) at 500 millsecs are
common and may be due to TCP issues (dropped packets say).
</p>
</li>

<li>symbols

<div class="org-src-container">

<pre class="src src-R"><span class="org-ess-function-call">summary</span><span class="org-builtin">(</span><span class="org-ess-function-call">as.factor</span><span class="org-builtin">(</span>stream$symbol<span class="org-builtin">[]))</span>
</pre>
</div>
</li>

<li>emini latency

<p>
The latency pattern for the E-MINI SP500 (@ESM13 is the iqfeed code) is
very similar to the overall latency pattern. The average latency over the
day was:
</p>

<div class="org-src-container">

<pre class="src src-R"><span class="org-constant">require</span><span class="org-builtin">(</span>ggplot2<span class="org-builtin">)</span>
<span class="org-constant">require</span><span class="org-builtin">(</span>bigvis<span class="org-builtin">)</span>
ind.emini <span class="org-constant">=</span> <span class="org-ess-function-call">indexEQ</span><span class="org-builtin">(</span>ind.symbol,<span class="org-string">"@ESM13 "</span><span class="org-builtin">)</span>
df1 <span class="org-constant">=</span> <span class="org-ess-function-call">condense</span><span class="org-builtin">(</span><span class="org-ess-function-call">bin</span><span class="org-builtin">(</span>event.df$event.time<span class="org-builtin">[</span>ind.emini<span class="org-builtin">]</span>,<span class="org-ess-numbers">300</span>,name<span class="org-constant">=</span><span class="org-string">"time"</span><span class="org-builtin">)</span>,<span class="org-ess-function-call">bin</span><span class="org-builtin">(</span>event.df$event.latency<span class="org-builtin">[</span>ind.emini<span class="org-builtin">]</span>,<span class="org-ess-numbers">0.05</span>,name<span class="org-constant">=</span><span class="org-string">"latency"</span><span class="org-builtin">))</span>
df2 <span class="org-constant">=</span> df1<span class="org-builtin">[(</span>df1$latency <span class="org-constant">&gt;</span> <span class="org-ess-numbers">0</span><span class="org-builtin">)</span> &amp; <span class="org-builtin">(</span>df1$latency <span class="org-constant">&lt;</span> <span class="org-ess-numbers">2</span><span class="org-builtin">)</span>,<span class="org-builtin">]</span>
lat.av <span class="org-constant">=</span> <span class="org-ess-function-call">tapply</span><span class="org-builtin">(</span>df2$latency*df2$.count,df2$time,sum<span class="org-builtin">)</span><span class="org-constant">/</span><span class="org-ess-function-call">tapply</span><span class="org-builtin">(</span>df2$.count,df2$time,sum<span class="org-builtin">)</span>
dfg <span class="org-constant">=</span> <span class="org-ess-function-call">data.frame</span><span class="org-builtin">(</span>Time<span class="org-constant">=</span><span class="org-ess-function-call">as.POSIXct</span><span class="org-builtin">(</span><span class="org-ess-function-call">as.double</span><span class="org-builtin">(</span><span class="org-ess-function-call">row.names</span><span class="org-builtin">(</span>lat.av<span class="org-builtin">))</span><span class="org-constant">+</span><span class="org-ess-numbers">10</span>*<span class="org-ess-numbers">60</span>*<span class="org-ess-numbers">60</span>,origin<span class="org-constant">=</span><span class="org-string">"1960-01-01"</span>, tz<span class="org-constant">=</span><span class="org-string">""</span><span class="org-builtin">)</span>,Latency<span class="org-constant">=</span>lat.av<span class="org-builtin">)</span>
<span class="org-comment-delimiter">#</span><span class="org-comment">colnames(dfg) = c("Time","Latency","Count")</span>
g <span class="org-constant">=</span> <span class="org-ess-function-call">ggplot</span><span class="org-builtin">(</span>data<span class="org-constant">=</span>dfg,<span class="org-ess-function-call">aes</span><span class="org-builtin">(</span>x<span class="org-constant">=</span>Time,y<span class="org-constant">=</span>Latency<span class="org-builtin">))</span>
g <span class="org-constant">+</span> <span class="org-ess-function-call">geom_point</span><span class="org-builtin">()</span>
<span class="org-ess-function-call">ggsave</span><span class="org-builtin">(</span><span class="org-string">"quote-latency-averagecondensed.svg"</span><span class="org-builtin">)</span>
</pre>
</div>


<div class="figure">
<p><img src="../blog/latency-research/quote-latency-averagecondensed.svg"  alt="quote-latency-averagecondensed.svg"/></p>
</div>
</li>
</ul>
</div>
</div>

        </div>
      </article>
    </div>  
    <div class ="span3">
      <div id="sidebar">
      <a href="https://twitter.com/share" class="twitter-share-button" data-hashtags="research">Tweet</a>
      <script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
      <!-- Place this tag where you want the +1 button to render. -->
<div class="g-plusone" data-annotation="bubble" data-size="medium" data-width="300"></div>

<!-- Place this tag after the last +1 button tag. -->
<script type="text/javascript">
  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script>

<div class="get-scarce">
      <p>feeds:   <a href="https://twitter.com/hyperq_">Twitter</a> | <a href="../index.xml">RSS</a> | <a href="http://eepurl.com/xZDev">Email</a>
      </p>
</div>


    <p>
      Top Posts:
      
    </p>
    <a class="postlink" href="../blog/event-feed-design.html">Event Feed Design</a><br><a class="postlink" href="../blog/signal-prediction.html">Signal Prediction</a><br><a class="postlink" href="../blog/statistical-forecasting.html">Statistical Forecasting</a><br><a class="postlink" href="../blog/latency-research.html">Latency Research</a>
    <p><br>Related Articles:<br></p><a class="postlink" href="../tags/research.html">research</a><br><a class="postlink" href="../tags/r.html">R</a>
</div>

    </div>
  </div>
  <div class="row-fluid">
      <div class="span9">
<div id="disqus_thread"></div>
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'scarce'; // required: replace example with your forum shortname

  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
</div>

  <hr>
<div id="footer">
  <div class="copyright" style="text-align: center;">
    Copyright <a href="http://github.com/hyperq">hyperq</a> 2013-2013

<p>Licensed under the Apache License, Version 2.0 (the "License");
you may not use this work except in compliance with the License.
You may obtain a copy of the License in the LICENSE file, or at:</p>

<p><a href="http://www.apache.org/licenses/LICENSE-2.0">http://www.apache.org/licenses/LICENSE-2.0</a></p>

<p>Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.</p>

  </div>  
  <p>
    Powered by
    <a href="http://twitter.github.com/bootstrap/">bootstrap</a>
     via 
    <a href="https://github.com/renard/o-blog">o-blog</a>.
  </p>
</div>

</div>
</body>
</html>
